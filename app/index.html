<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–æ–º—É–Ω–∞–ª–∫–û–±–ª—ñ–∫</title>
    <meta name="theme-color" content="#0f172a">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #0099ff;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-sec: #64748b;
            --border: #cbd5e1;
            --input-bg: #ffffff;
            --danger: #ef4444;
            --success: #10b981;
            --header-bg: #ffffff;
            --radius: 16px;
            --viber: #7360f2;
            --telegram: #229ED9;
            --whatsapp: #25D366;
            --gold: #f59e0b;
        }

        body.dark-mode {
            --bg: #0b1121;
            --card: #151e32;
            --text: #f1f5f9;
            --text-sec: #94a3b8;
            --border: #334155;
            --input-bg: #1e293b;
            --header-bg: #151e32;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px;
            padding-bottom: 140px;
            -webkit-tap-highlight-color: transparent;
            line-height: 1.4;
        }

        /* UI Elements */
        .top-menu-bar { display: flex; justify-content: center; gap: 20px; font-size: 12px; font-weight: 700; color: var(--text-sec); margin-bottom: 15px; padding-top: 5px; text-transform: uppercase; letter-spacing: 1px; align-items: center; }
        .top-menu-bar span { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        /* –ö–Ω–æ–ø–∫–∞ —Ç–µ–º–∏ –≤ –º–µ–Ω—é */
        .theme-toggle-btn { background: none; border: none; cursor: pointer; font-size: 16px; padding: 0; }

        .brand-header { display: flex; align-items: center; justify-content: center; margin: 5px 0 20px 0; }
        
        /* –°—Ç–∏–ª—å —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ª–æ–≥–æ—Ç–∏–ø–∞ */
        .logo-brand-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 28px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .txt-main { color: var(--text); }
        .txt-neon { color: var(--primary); text-shadow: 0 0 15px rgba(0, 153, 255, 0.4); position: relative; }
        .styled-o { display: inline-block; position: relative; }
        .styled-o::after {
            content: ''; position: absolute;
            top: 53%; left: 50%; transform: translate(-50%, -50%);
            width: 30%; height: 30%;
            background-color: var(--bg);
            border-radius: 50%;
            z-index: 2;
        }

        .app-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; background: var(--header-bg); padding: 8px 12px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .nav-btn { font-size: 24px; color: var(--primary); padding: 5px; cursor: pointer; }
        .object-title { font-size: 16px; font-weight: 700; border: none; text-align: center; width: 100%; background: transparent; color: var(--text); text-transform: uppercase; font-family: 'Montserrat', sans-serif; }
        
        .status-badge { font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 6px; text-transform: uppercase; display: inline-block; margin-top: 2px; background: var(--border); color: var(--text-sec); cursor: pointer; }
        .status-pro { background: linear-gradient(135deg, #0099ff, #0066cc); color: white; box-shadow: 0 2px 5px rgba(0,153,255,0.3); }
        .status-vip { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; box-shadow: 0 2px 5px rgba(245,158,11,0.3); }

        .card { background: var(--card); border-radius: var(--radius); padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .section-title { font-size: 11px; color: var(--text-sec); font-weight: 700; text-transform: uppercase; margin: 15px 0 10px 0; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        .col { flex: 1; min-width: 0; }
        label { display: block; font-size: 11px; color: var(--text-sec); margin-bottom: 4px; font-weight: 600; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 12px; font-size: 16px; background: var(--input-bg); color: var(--text); box-sizing: border-box; transition: 0.2s; }
        input:focus { border-color: var(--primary); outline: none; }
        
        .btn { display: flex; justify-content: center; align-items: center; width: 100%; padding: 12px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; text-align: center; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--gold); color: white; }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-add { background: rgba(0, 153, 255, 0.1); color: var(--primary); border: 1px dashed var(--primary); margin-top: 10px; font-size: 12px; }
        .btn-add-counter { background: rgba(245, 158, 11, 0.1); color: var(--gold); border: 1px dashed var(--gold); margin-top: 5px; font-size: 12px; }
        .btn-sm { padding: 8px 12px; font-size: 12px; width: auto; }
        
        .btn-viber { background: var(--viber); color: white; border: none; }
        .btn-telegram { background: var(--telegram); color: white; border: none; }
        .btn-whatsapp { background: var(--whatsapp); color: white; border: none; }

        details { margin-bottom: 15px; border: 1px solid var(--border); border-radius: 14px; background: var(--card); overflow: hidden; }
        summary { padding: 15px; background: rgba(0,0,0,0.02); font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; list-style: none; color: var(--text); }
        .content { padding: 20px; border-top: 1px solid var(--border); }
        
        .sticky-footer { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 10px; display: flex; justify-content: center; gap: 8px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: var(--card); color: var(--text); width: 100%; max-width: 450px; padding: 25px; border-radius: 24px; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: var(--text-sec); }
        
        .custom-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .del-icon { color: var(--danger); font-size: 20px; padding: 0 8px; cursor: pointer; }
        .counter-row { background: rgba(0,0,0,0.02); padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border); }

        .price-card { border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; background: var(--bg); position: relative; overflow: hidden; }
        .price-card.popular { border-color: var(--primary); background: rgba(0, 153, 255, 0.03); }
        .price-badge { position: absolute; top: 0; right: 0; background: var(--primary); color: white; font-size: 10px; padding: 3px 8px; border-bottom-left-radius: 8px; font-weight: bold; }
        .price-title { font-size: 16px; font-weight: 900; margin-bottom: 5px; text-transform: uppercase; font-family: 'Montserrat', sans-serif; }
        .price-val { font-size: 20px; font-weight: bold; color: var(--text); margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="top-menu-bar">
        <button class="theme-toggle-btn" onclick="app.toggleTheme()" id="theme-icon">üåó</button>
        <span onclick="app.openMenu('info')">‚ÑπÔ∏è –Ü–Ω—Ñ–æ</span>
        <span onclick="app.openMenu('premium')" style="color:var(--primary)">üíé PRO</span>
        <span onclick="app.openMenu('contacts')">üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏</span>
    </div>

    <div class="brand-header">
        <div class="logo-brand-text">
            <span class="txt-main">–ö–æ–º—É–Ω–∞–ª–∫</span>
            <span class="txt-neon"><span class="styled-o">–û</span>–±–ª—ñ–∫</span>
        </div>
    </div>

    <div class="app-header">
        <div class="nav-btn" onclick="app.prevObject()">‚ùÆ</div>
        <div style="flex:1; text-align:center; position: relative;">
            <div style="display:flex; align-items:center; justify-content:center; gap:5px;">
                <input type="text" id="object-title" class="object-title" value="–ú—ñ–π –û–±'—î–∫—Ç" onchange="app.updateObjectName(this.value)" placeholder="–ù–ê–ó–í–ê –û–ë'–Ñ–ö–¢–£">
                <span onclick="app.deleteObject()" style="color:var(--danger); cursor:pointer; font-size:16px;">üóë</span>
            </div>
            <div id="status-badge" class="status-badge" onclick="app.openMenu('premium')">FREE</div>
        </div>
        <div class="nav-btn" onclick="app.addObject()" title="–î–æ–¥–∞—Ç–∏ –æ–±'—î–∫—Ç">+</div>
        <div class="nav-btn" onclick="app.nextObject()">‚ùØ</div>
    </div>
    <div id="main-content-wrapper">
        <details>
            <summary>‚öôÔ∏è –¢–∞—Ä–∏—Ñ–∏ —Ç–∞ –†–µ–∫–≤—ñ–∑–∏—Ç–∏</summary>
            <div class="content">
                <div class="section-title">–ë–∞–∑–æ–≤—ñ –¢–∞—Ä–∏—Ñ–∏ (–≥—Ä–Ω)</div>
                <div class="row">
                    <div class="col"><label>‚ö° –î–µ–Ω—å</label><input type="number" id="t_ed" onchange="app.setTariff('el_d',this.value)"></div>
                    <div class="col"><label>üåô –ù—ñ—á</label><input type="number" id="t_en" onchange="app.setTariff('el_n',this.value)"></div>
                </div>
                <div class="row">
                    <div class="col"><label>üíß –í–æ–¥–∞</label><input type="number" id="t_w" onchange="app.setTariff('w',this.value)"></div>
                    <div class="col"><label>üî• –ì–∞–∑</label><input type="number" id="t_g" onchange="app.setTariff('g',this.value)"></div>
                </div>
                
                <div class="section-title">–î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–∏—Ç—Ä–∞—Ç–∏ (–ú–ó–ö)</div>
                <div id="extra-tariffs-container"></div>
                <button class="btn btn-add" onclick="app.addExtraTariff()">+ –†—è–¥–æ–∫ –≤–∏—Ç—Ä–∞—Ç</button>
                
                <div class="section-title" style="margin-top:20px;">–ë–∞–Ω–∫—ñ–≤—Å—å–∫—ñ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏</div>
                <div id="requisites-container"></div>
                <button class="btn btn-add" onclick="app.addRequisite()">+ –î–æ–¥–∞—Ç–∏ –∫–∞—Ä—Ç–∫—É/IBAN</button>
            </div>
        </details>

        <div id="groups-container"></div>
        <div style="text-align:center; margin: 20px 0;">
            <button class="btn btn-outline" style="width:auto; display:inline-block; padding:10px 20px;" onclick="app.addGroup()">+ –ì—Ä—É–ø–∞ –ú–ó–ö (–í—Ö—ñ–¥)</button>
        </div>

        <div id="apartments-container"></div>
        
        <div style="text-align:center; margin: 30px 0;">
            <button class="btn btn-primary" style="width:auto; display:inline-block; padding:12px 30px; font-size:16px; box-shadow: 0 4px 15px rgba(0, 153, 255, 0.4);" onclick="app.addApartment()">
                + –î–æ–¥–∞—Ç–∏ –ö–≤–∞—Ä—Ç–∏—Ä—É
            </button>
            <div style="font-size:11px; color:var(--text-sec); margin-top:8px;">–õ—ñ–º—ñ—Ç: <span id="limit-counter">0/2</span></div>
        </div>
    </div>
    
    <div style="height: 120px;"></div>

    <div class="sticky-footer">
        <button class="btn btn-warning" style="flex:1;" onclick="app.downloadBackup()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <button class="btn btn-outline" style="flex:1; border-color:var(--border); color:var(--text);" onclick="document.getElementById('file-input').click()">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
        <button class="btn btn-success" style="flex:1.5;" onclick="app.calculate()">‚úÖ –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
        <input type="file" id="file-input" style="display:none" accept=".json, .txt, application/json, text/plain" onchange="app.loadBackup(this)">
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('resultModal').style.display='none'">&times;</span>
            <h3 style="margin-top:0; text-align:center; font-family:'Montserrat',sans-serif;">–ö–≤–∏—Ç–∞–Ω—Ü—ñ—ó</h3>
            <div id="mzk-info" style="background:var(--bg); padding:12px; border-radius:10px; margin-bottom:20px; font-size:13px; text-align:center; border:1px solid var(--border);"></div>
            <div id="results-list"></div>
            <hr style="margin: 20px 0; border:0; border-top:1px solid var(--border);">
            <button class="btn btn-danger" onclick="app.startNewMonth()">üóì –ó–∞–∫—Ä–∏—Ç–∏ –º—ñ—Å—è—Ü—å</button>
        </div>
    </div>

    <div id="menuModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('menuModal').style.display='none'">&times;</span>
            <h3 style="margin-top:0; text-align:center;" id="menu-title">–ú–µ–Ω—é</h3>
            
            <div id="menu-content-info" style="display:none" class="info-block">
                <p style="text-align:center;"><strong>–ö–æ–º—É–Ω–∞–ª–∫–û–±–ª—ñ–∫ v3.0</strong></p>
                <hr style="border:0; border-top:1px solid var(--border)">
                <h4>üè† –ù–æ–≤–µ –≤ –≤–µ—Ä—Å—ñ—ó 3.0</h4>
                <ul>
                    <li>–î–æ–¥–∞–≤–∞–π—Ç–µ –≤–ª–∞—Å–Ω—ñ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏!</li>
                    <li>–í–∏–¥–∞–ª–µ–Ω–Ω—è –æ–±'—î–∫—Ç—ñ–≤.</li>
                    <li>–û–Ω–æ–≤–ª–µ–Ω–∏–π –¥–∏–∑–∞–π–Ω.</li>
                </ul>
                <h4>üìä –Ø–∫ —Ä–∞—Ö—É—î—Ç—å—Å—è –ú–ó–ö?</h4>
                <p>–†—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ –∑–∞–≥–∞–ª—å–Ω–∏–º –ª—ñ—á–∏–ª—å–Ω–∏–∫–æ–º —Ç–∞ —Å—É–º–æ—é –∫–≤–∞—Ä—Ç–∏—Ä –¥—ñ–ª–∏—Ç—å—Å—è –Ω–∞ –≤—Å—ñ—Ö.</p>
            </div>

            <div id="menu-content-premium" style="display:none">
                <p style="font-size:13px; text-align:center; color:var(--text-sec); margin-bottom:15px;">–û–±–µ—Ä—ñ—Ç—å —Å–≤—ñ–π —Ç–∞—Ä–∏—Ñ–Ω–∏–π –ø–ª–∞–Ω:</p>
                <div id="tariffs-list"></div>
                <div style="margin-top:20px; padding-top:15px; border-top:1px dashed var(--border);">
                    <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">–í–∂–µ –º–∞—î—Ç–µ –∫–ª—é—á?</div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="activation-key" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó">
                        <button class="btn btn-primary" style="width:auto;" onclick="app.activatePro()">OK</button>
                    </div>
                </div>
            </div>

            <div id="menu-content-contacts" style="display:none">
                <div style="text-align:center;">
                    <p>Telegram –ü—ñ–¥—Ç—Ä–∏–º–∫–∞:</p>
                    <a href="https://t.me/comunalco" target="_blank" class="btn btn-telegram" style="text-decoration:none; margin-bottom:15px;">@comunalco</a>
                    <a href="mailto:support@comunalco.com" class="btn btn-outline" style="text-decoration:none; color:var(--text); border-color:var(--border)">support@comunalco.com</a>
                </div>
            </div>
        </div>
    </div>

    <div id="payModal" class="modal" style="z-index: 2100;">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('payModal').style.display='none'">&times;</span>
            <h3 style="margin-top:0; text-align:center;">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –ø—ñ–¥–ø–∏—Å–∫–∏</h3>
            <div id="pay-details" style="text-align:center; font-weight:bold; margin-bottom:15px; color:var(--primary);"></div>
            <label>–í–∞—à Telegram</label>
            <input type="text" id="pay-contact" placeholder="@username" oninput="app.validatePayForm()">
            <label style="margin-top:10px;">Email</label>
            <input type="email" id="pay-email" placeholder="mail@example.com" oninput="app.validatePayForm()">
            <button id="btn-do-pay" class="btn btn-success" disabled onclick="app.processPayment()" style="margin-top:15px;">üí≥ –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–ª—é—á</button>
        </div>
    </div>
<script>
class App {
    constructor() {
        this.LIMITS = { free: 2, standard: 10, pro: 9999, vip: 9999 };
        this.TARIFF_PLANS = [
            { id: 'std_6', name: '–†–∞–Ω—Ç—å—î (6 –º—ñ—Å)', limit: 10, price: 300, desc: '–î–æ 10 –∫–≤–∞—Ä—Ç–∏—Ä. 50 –≥—Ä–Ω/–º—ñ—Å' },
            { id: 'std_12', name: '–†–∞–Ω—Ç—å—î (1 —Ä—ñ–∫)', limit: 10, price: 499, desc: '–î–æ 10 –∫–≤–∞—Ä—Ç–∏—Ä. –í–∏–≥–æ–¥–∞ 17%', isPopular: true },
            { id: 'pro_6', name: 'PRO (6 –º—ñ—Å)', limit: 9999, price: 750, desc: '–ë–µ–∑–ª—ñ–º—ñ—Ç. –î–ª—è –±—ñ–∑–Ω–µ—Å—É.' },
            { id: 'pro_12', name: 'PRO (1 —Ä—ñ–∫)', limit: 9999, price: 1190, desc: '–ë–µ–∑–ª—ñ–º—ñ—Ç. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –≤–∏–≥–æ–¥–∞.' },
            { id: 'vip', name: 'LIFETIME', limit: 9999, price: 2900, desc: '–ù–∞–∑–∞–≤–∂–¥–∏. –û–ø–ª–∞—Ç–∞ 1 —Ä–∞–∑.', isVip: true }
        ];

        this.state = { license: { type: 'free', exp: null }, currentObjIdx: 0, objects: [] };
        this.checks = {};
        this.STORAGE_KEY = 'komunalka_v30_pro'; 
        this.pendingPayment = null; 
        this.init();
    }
    
    init() { this.load(); this.initTheme(); this.renderAll(); this.updateStatus(); }
    
    // --- UI & THEME ---
    initTheme() { 
        const isDark = localStorage.getItem('theme')==='dark';
        if(isDark) document.body.classList.add('dark-mode'); 
        const icon = document.getElementById('theme-icon');
        if(icon) icon.innerText = isDark ? '‚òÄÔ∏è' : 'üåë';
    }
    toggleTheme() { 
        document.body.classList.toggle('dark-mode'); 
        localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); 
        this.initTheme(); 
    }

    openMenu(id) {
        document.getElementById('menuModal').style.display='flex';
        ['info','premium','contacts'].forEach(k => document.getElementById('menu-content-'+k).style.display='none');
        const el = document.getElementById('menu-content-'+id);
        if(el) el.style.display='block';
        if(id === 'premium') this.renderTariffs();
    }

    // --- OBJECTS MANAGEMENT ---
    createDefaultObject(name) {
        return {
            id: Date.now(), name: name || "–ú—ñ–π –û–±'—î–∫—Ç",
            tariffs: { el_d: 4.32, el_n: 2.16, w: 30.0, g: 8.0 }, 
            extra_tariffs: [], 
            requisites: [{ id: 1, name: "–ö–∞—Ä—Ç–∫–∞", val: "" }],
            // –î–æ–¥–∞–Ω–æ –º–∞—Å–∏–≤ custom_counters –¥–ª—è –≥—Ä—É–ø —Ç–∞ –∫–≤–∞—Ä—Ç–∏—Ä
            groups: [{ id: 1, name: "–í—Ö—ñ–¥–Ω–∞ –ì—Ä—É–ø–∞", prev: { ed: 0, en: 0, w: 0, g: 0 }, curr: { ed: 0, en: 0, w: 0, g: 0 }, custom_counters: [], services: [] }],
            apartments: [{ id: 1, name: "–ö–≤. 1", group_id: 1, messenger: 'viber', email: '', phone: '', prev: { ed: 0, en: 0, w: 0, g: 0 }, curr: { ed: 0, en: 0, w: 0, g: 0 }, custom_counters: [], services: [], paid: 0, debt: 0 }]
        };
    }

    load() { 
        const d = localStorage.getItem(this.STORAGE_KEY); 
        if (d) { 
            try { 
                this.state = JSON.parse(d); 
                if(!this.state.objects.length) this.state.objects=[this.createDefaultObject()];
                // Migration for old versions (add custom_counters if missing)
                this.state.objects.forEach(o => {
                    o.groups.forEach(g => { if(!g.custom_counters) g.custom_counters = []; });
                    o.apartments.forEach(a => { if(!a.custom_counters) a.custom_counters = []; });
                });
            } catch(e) { this.state.objects=[this.createDefaultObject()]; } 
        } else { this.state.objects=[this.createDefaultObject()]; } 
        if(this.state.currentObjIdx >= this.state.objects.length) this.state.currentObjIdx=0; 
    }
    
    save() { localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.state)); this.updateStatus(); }
    get currentData() { return this.state.objects[this.state.currentObjIdx]; }
    
    updateObjectName(v) { this.currentData.name = v; this.save(); }
    
    addObject() { 
        this.state.objects.push(this.createDefaultObject(`–û–±'—î–∫—Ç ${this.state.objects.length+1}`)); 
        this.state.currentObjIdx=this.state.objects.length-1; 
        this.save(); this.renderAll(); 
    }

    deleteObject() {
        if(this.state.objects.length <= 1) { alert("–ù–µ –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π –æ–±'—î–∫—Ç!"); return; }
        if(confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –æ–±'—î–∫—Ç "${this.currentData.name}" —Ç–∞ –≤—Å—ñ –π–æ–≥–æ –¥–∞–Ω—ñ?`)) {
            this.state.objects.splice(this.state.currentObjIdx, 1);
            this.state.currentObjIdx = 0;
            this.save(); this.renderAll();
        }
    }
    
    prevObject() { if(this.state.currentObjIdx>0){this.state.currentObjIdx--; this.save(); this.renderAll();} }
    nextObject() { if(this.state.currentObjIdx<this.state.objects.length-1){this.state.currentObjIdx++; this.save(); this.renderAll();} }
    
    updateStatus() {
        const cnt = this.state.objects.reduce((s,o)=>s+o.apartments.length,0);
        const bad = document.getElementById('status-badge');
        const lim = document.getElementById('limit-counter');
        const lic = this.state.license || {type:'free'};
        let limit = this.LIMITS[lic.type] || 2;
        bad.innerText = lic.type === 'free' ? 'FREE' : lic.type.toUpperCase();
        bad.className = `status-badge ${lic.type === 'free' ? '' : (lic.type==='vip'?'status-vip':'status-pro')}`;
        lim.innerText = limit > 1000 ? "‚àû" : `${cnt}/${limit}`;
    }

    addApartment() { 
        if(!this.checkLimit()) return;
        this.currentData.apartments.push({id:Date.now(), name:`–ö–≤. ${this.currentData.apartments.length+1}`, group_id:1, messenger:'viber', email:'', phone:'', prev:{}, curr:{}, custom_counters:[], services:[], paid:0, debt:0}); 
        this.save(); this.renderApartments(); this.updateStatus(); 
    }

    checkLimit() {
        const cnt = this.state.objects.reduce((s,o)=>s+o.apartments.length,0);
        const lic = this.state.license || {type:'free'};
        const limit = this.LIMITS[lic.type] || this.LIMITS.free;
        if(cnt >= limit) {
            alert(`–î–æ—Å—è–≥–Ω—É—Ç–æ –ª—ñ–º—ñ—Ç —Ç–∞—Ä–∏—Ñ—É. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –≤ –º–µ–Ω—é PRO.`);
            this.openMenu('premium');
            return false;
        }
        return true;
    }

    // --- RENDERING ---
    renderAll() {
        document.getElementById('object-title').value = this.currentData.name;
        ['ed','en','w','g'].forEach(k => { 
            const el = document.getElementById('t_'+k); 
            const map = {ed:'el_d', en:'el_n', w:'w', g:'g'};
            if(el) el.value = this.currentData.tariffs[map[k]]; 
        });
        this.renderExtraTariffs(); this.renderRequisites(); this.renderGroups(); this.renderApartments();
    }
    
    renderExtraTariffs() { 
        document.getElementById('extra-tariffs-container').innerHTML = this.currentData.extra_tariffs.map((t, i) => 
            `<div class="custom-row"><input type="text" value="${t.name}" placeholder="–ü–æ—Å–ª—É–≥–∞" onchange="app.updateExtraTariff(${i}, 'name', this.value)"><input type="number" value="${t.val}" placeholder="–¶—ñ–Ω–∞" onchange="app.updateExtraTariff(${i}, 'val', this.value)"><span class="del-icon" onclick="app.delExtraTariff(${i})">&times;</span></div>`
        ).join(''); 
    }
    renderRequisites() { 
        document.getElementById('requisites-container').innerHTML = this.currentData.requisites.map((r, i) => 
            `<div class="custom-row"><input type="text" value="${r.name}" placeholder="–ë–∞–Ω–∫" onchange="app.updateReq(${i}, 'name', this.value)"><input type="text" value="${r.val}" placeholder="IBAN" onchange="app.updateReq(${i}, 'val', this.value)"><span class="del-icon" onclick="app.delReq(${i})">&times;</span></div>`
        ).join(''); 
    }
    
    renderGroups() { 
        document.getElementById('groups-container').innerHTML = this.currentData.groups.map((g, i) => `
        <div class="card" style="border-left: 4px solid var(--text-sec);">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:700;">
                <span contenteditable="true" onblur="app.updateGroup(${i},'name',this.innerText)" style="border-bottom:1px dashed var(--border)">${g.name}</span>
                <span class="del-icon" onclick="app.delGroup(${i})">&times;</span>
            </div>
            ${this.renderMR(i,g,'prev','‚ö° –í—Ö—ñ–¥ –î–µ–Ω—å','ed')} ${this.renderMR(i,g,'prev','üåô –í—Ö—ñ–¥ –ù—ñ—á','en')}
            ${this.renderMR(i,g,'prev','üíß –í—Ö—ñ–¥ –í–æ–¥–∞','w')} ${this.renderMR(i,g,'prev','üî• –í—Ö—ñ–¥ –ì–∞–∑','g')}
            
            <div id="g-counters-${i}">
                ${(g.custom_counters||[]).map((c, ci) => this.renderCustomCounterRow('group', i, ci, c)).join('')}
            </div>
            <button class="btn btn-add-counter" onclick="app.addCustomCounter('group', ${i})">+ –õ—ñ—á–∏–ª—å–Ω–∏–∫</button>

            <div style="margin-top:10px; border-top:1px dashed var(--border); padding-top:10px;">
                <div style="font-size:11px; font-weight:700; color:var(--text-sec); margin-bottom:5px;">–°–ü–Ü–õ–¨–ù–Ü –ü–û–°–õ–£–ì–ò (–ú–ó–ö)</div>
                ${(g.services || []).map((s,si)=>`<div class="custom-row"><input type="text" value="${s.name}" placeholder="–ù–∞–∑–≤–∞" onchange="app.updateGS(${i},${si},'name',this.value)"><input type="number" value="${s.val}" placeholder="–°—É–º–∞" onchange="app.updateGS(${i},${si},'val',this.value)"><span class="del-icon" onclick="app.delGS(${i},${si})">&times;</span></div>`).join('')}
                <button class="btn btn-add" onclick="app.addGS(${i})">+ –ü–æ—Å–ª—É–≥–∞</button>
            </div>
        </div>`).join(''); 
    }

    renderApartments() { 
        document.getElementById('apartments-container').innerHTML = this.currentData.apartments.map((a, i) => { 
            return `<details style="border-left: 4px solid var(--primary)">
            <summary>
                <div>üö™ <span contenteditable="true" onclick="event.preventDefault()" onblur="app.updateApt(${i},'name',this.innerText)" style="font-weight:700">${a.name}</span> <span style="font-size:12px; opacity:0.7" id="badge-${i}"></span></div>
                <span class="del-icon" onclick="app.delApt(${i})">&times;</span>
            </summary>
            <div class="content">
                <div class="row">
                    <div class="col" style="flex:0.6"><label>–ú–µ—Å–µ–Ω–¥–∂–µ—Ä</label><select onchange="app.updateApt(${i},'messenger',this.value)"><option value="viber" ${a.messenger==='viber'?'selected':''}>Viber</option><option value="whatsapp" ${a.messenger==='whatsapp'?'selected':''}>WhatsApp</option><option value="telegram" ${a.messenger==='telegram'?'selected':''}>Telegram</option></select></div>
                    <div class="col"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="tel" value="${a.phone||''}" placeholder="380..." oninput="app.updateApt(${i},'phone',this.value)"></div>
                </div>
                
                <div class="section-title">–õ—ñ—á–∏–ª—å–Ω–∏–∫–∏</div>
                ${this.renderMR(i,a,'apt','‚ö° –ï/–ï –î–µ–Ω—å','ed')} ${this.renderMR(i,a,'apt','üåô –ï/–ï –ù—ñ—á','en')}
                ${this.renderMR(i,a,'apt','üíß –í–æ–¥–∞','w')} ${this.renderMR(i,a,'apt','üî• –ì–∞–∑','g')}
                
                <div id="a-counters-${i}">
                    ${(a.custom_counters||[]).map((c, ci) => this.renderCustomCounterRow('apt', i, ci, c)).join('')}
                </div>
                <button class="btn btn-add-counter" onclick="app.addCustomCounter('apt', ${i})">+ –õ—ñ—á–∏–ª—å–Ω–∏–∫</button>

                <div class="section-title" style="margin-top:15px">–ü–æ—Å–ª—É–≥–∏</div>
                <div id="a-serv-${i}">${a.services.map((s,si)=>`<div class="custom-row"><input type="text" value="${s.name}" placeholder="–ù–∞–∑–≤–∞" onchange="app.updateAS(${i},${si},'name',this.value)"><input type="number" value="${s.val}" placeholder="–°—É–º–∞" onchange="app.updateAS(${i},${si},'val',this.value)"><span class="del-icon" onclick="app.delAS(${i},${si})">&times;</span></div>`).join('')}</div>
                <button class="btn btn-add" onclick="app.addAS(${i})">+ –Ü–Ω–¥–∏–≤. –ø–æ—Å–ª—É–≥–∞</button>
                
                <div class="section-title">–ë–∞–ª–∞–Ω—Å</div>
                <div class="row">
                    <div class="col"><label>–ë–æ—Ä–≥</label><input type="number" value="${a.debt||0}" onchange="app.updateApt(${i},'debt',this.value)"></div>
                    <div class="col"><label style="color:var(--success)">–°–ø–ª–∞—á–µ–Ω–æ</label><input type="number" value="${a.paid||''}" placeholder="0.00" onchange="app.updateApt(${i},'paid',this.value)" style="border-color:var(--success)"></div>
                </div>
            </div></details>`; 
        }).join(''); 
    }

    renderMR(i, obj, mode, label, key) { 
        const p = obj.prev[key]; const c = obj.curr[key]; 
        const fn = mode==='prev'?`app.updateGroupMetric(${i},`:`app.updateAptMetric(${i},`; 
        return `<div class="row" style="align-items:center;">
            <div class="col" style="flex:0.6"><span style="font-size:13px; font-weight:600;">${label}</span></div>
            <div class="col"><input type="number" placeholder="–ë—É–ª–æ" value="${p||0}" onchange="${fn}'prev','${key}',this.value)" style="background:var(--bg)"></div>
            <div class="col"><input type="number" placeholder="–°—Ç–∞–ª–æ" value="${c||0}" onchange="${fn}'curr','${key}',this.value)"></div>
        </div>`; 
    }

    // --- CUSTOM COUNTERS LOGIC ---
    renderCustomCounterRow(type, parentIdx, cIdx, cData) {
        // type: 'group' or 'apt'
        return `
        <div class="counter-row">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <input type="text" value="${cData.name}" placeholder="–ù–∞–∑–≤–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞" style="border:none; background:transparent; font-weight:bold; font-size:13px; width:60%;" onchange="app.updateCustomCounter('${type}', ${parentIdx}, ${cIdx}, 'name', this.value)">
                <span class="del-icon" onclick="app.delCustomCounter('${type}', ${parentIdx}, ${cIdx})">&times;</span>
            </div>
            <div class="row" style="margin-bottom:0;">
                <div class="col" style="flex:0.8"><input type="number" value="${cData.price}" placeholder="–¢–∞—Ä–∏—Ñ" title="–¶—ñ–Ω–∞ –∑–∞ –æ–¥–∏–Ω–∏—Ü—é" onchange="app.updateCustomCounter('${type}', ${parentIdx}, ${cIdx}, 'price', this.value)"></div>
                <div class="col"><input type="number" value="${cData.prev}" placeholder="–ë—É–ª–æ" onchange="app.updateCustomCounter('${type}', ${parentIdx}, ${cIdx}, 'prev', this.value)" style="background:var(--bg)"></div>
                <div class="col"><input type="number" value="${cData.curr}" placeholder="–°—Ç–∞–ª–æ" onchange="app.updateCustomCounter('${type}', ${parentIdx}, ${cIdx}, 'curr', this.value)"></div>
            </div>
        </div>`;
    }

    addCustomCounter(type, parentIdx) {
        const newCounter = { id: Date.now(), name: "–õ—ñ—á–∏–ª—å–Ω–∏–∫", price: 0, prev: 0, curr: 0 };
        if (type === 'group') {
            if(!this.currentData.groups[parentIdx].custom_counters) this.currentData.groups[parentIdx].custom_counters = [];
            this.currentData.groups[parentIdx].custom_counters.push(newCounter);
            this.renderGroups();
        } else {
            if(!this.currentData.apartments[parentIdx].custom_counters) this.currentData.apartments[parentIdx].custom_counters = [];
            this.currentData.apartments[parentIdx].custom_counters.push(newCounter);
            this.renderApartments();
        }
        this.save();
    }

    updateCustomCounter(type, pIdx, cIdx, key, val) {
        const target = type === 'group' ? this.currentData.groups[pIdx] : this.currentData.apartments[pIdx];
        target.custom_counters[cIdx][key] = (key === 'name') ? val : parseFloat(val);
        this.save();
    }

    delCustomCounter(type, pIdx, cIdx) {
        if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫?")) return;
        const target = type === 'group' ? this.currentData.groups[pIdx] : this.currentData.apartments[pIdx];
        target.custom_counters.splice(cIdx, 1);
        this.save();
        type === 'group' ? this.renderGroups() : this.renderApartments();
    }

    // --- DATA UPDATES ---
    setTariff(k,v) { this.currentData.tariffs[k]=parseFloat(v); this.save(); }
    addExtraTariff(){this.currentData.extra_tariffs.push({name:"",val:0});this.save();this.renderExtraTariffs();}
    updateExtraTariff(i,k,v){this.currentData.extra_tariffs[i][k]=k==='val'?parseFloat(v):v;this.save();}
    delExtraTariff(i){if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏?")){this.currentData.extra_tariffs.splice(i,1);this.save();this.renderExtraTariffs();}}
    
    addRequisite(){this.currentData.requisites.push({name:"",val:""});this.save();this.renderRequisites();}
    updateReq(i,k,v){this.currentData.requisites[i][k]=v;this.save();}
    delReq(i){if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏?")){this.currentData.requisites.splice(i,1);this.save();this.renderRequisites();}}
    
    updateGroup(i,k,v){this.currentData.groups[i][k]=v;this.save();}
    updateGroupMetric(i,t,k,v){this.currentData.groups[i][t][k]=parseFloat(v);this.save();}
    addGroup(){this.currentData.groups.push({id:Date.now(),name:"–ì—Ä—É–ø–∞ –ú–ó–ö",prev:{},curr:{}, custom_counters:[], services:[]});this.save();this.renderGroups();}
    delGroup(i){if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≥—Ä—É–ø—É?")){this.currentData.groups.splice(i,1);this.save();this.renderGroups();}}
    
    addGS(i){ if(!this.currentData.groups[i].services) this.currentData.groups[i].services = []; this.currentData.groups[i].services.push({name:"",val:0}); this.save(); this.renderGroups(); }
    updateGS(gi,si,k,v){ this.currentData.groups[gi].services[si][k]=k==='val'?parseFloat(v):v; this.save(); }
    delGS(gi,si){ this.currentData.groups[gi].services.splice(si,1); this.save(); this.renderGroups(); }

    updateApt(i,k,v){this.currentData.apartments[i][k]=(k==='debt'||k==='paid')?parseFloat(v):v;this.save();}
    updateAptMetric(i,t,k,v){this.currentData.apartments[i][t][k]=parseFloat(v);this.save();}
    addAS(i){this.currentData.apartments[i].services.push({name:"",val:0});this.save();this.renderApartments();}
    updateAS(ai,si,k,v){this.currentData.apartments[ai].services[si][k]=k==='val'?parseFloat(v):v;this.save();}
    delAS(ai,si){this.currentData.apartments[ai].services.splice(si,1);this.save();this.renderApartments();}
    delApt(i){if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É?")){this.currentData.apartments.splice(i,1);this.save();this.renderApartments(); this.updateStatus();}}

    // --- CALCULATIONS ---
    calculate() {
        const d = this.currentData; const t = d.tariffs;
        let totalIn={ed:0,en:0,w:0,g:0}, gServSum=0, totalApts={ed:0,en:0,w:0,g:0};
        
        d.groups.forEach(g => { 
            totalIn.ed += Math.max(0,(g.curr.ed||0)-(g.prev.ed||0)); 
            totalIn.en += Math.max(0,(g.curr.en||0)-(g.prev.en||0)); 
            totalIn.w += Math.max(0,(g.curr.w||0)-(g.prev.w||0)); 
            totalIn.g += Math.max(0,(g.curr.g||0)-(g.prev.g||0)); 
            if(g.services) g.services.forEach(s => gServSum += (s.val||0));
        });
        
        d.apartments.forEach(a => { 
            totalApts.ed += Math.max(0,(a.curr.ed||0)-(a.prev.ed||0)); 
            totalApts.en += Math.max(0,(a.curr.en||0)-(a.prev.en||0)); 
            totalApts.w += Math.max(0,(a.curr.w||0)-(a.prev.w||0)); 
            totalApts.g += Math.max(0,(a.curr.g||0)-(a.prev.g||0)); 
        });
        
        d.extra_tariffs.forEach(et => gServSum += (et.val || 0));

        let mzk = { ed: Math.max(0,totalIn.ed-totalApts.ed), en: Math.max(0,totalIn.en-totalApts.en), w: Math.max(0,totalIn.w-totalApts.w), g: Math.max(0,totalIn.g-totalApts.g) };
        let mzkCost = (mzk.ed*t.el_d) + (mzk.en*t.el_n) + (mzk.w*t.w) + (mzk.g*t.g) + gServSum;
        let mzkPerApt = d.apartments.length ? mzkCost/d.apartments.length : 0;
        
        document.getElementById('mzk-info').innerHTML = `<div>–ú–ó–ö –í—Å—å–æ–≥–æ: <b>${mzkCost.toFixed(2)}</b> –≥—Ä–Ω | –ù–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É: <b>${mzkPerApt.toFixed(2)}</b> –≥—Ä–Ω</div>`;
        const dStr = new Date().toLocaleDateString('uk-UA');
        
        document.getElementById('results-list').innerHTML = d.apartments.map((a, i) => {
            // Standard Counters
            const c = { ed: Math.max(0,(a.curr.ed||0)-(a.prev.ed||0)), en: Math.max(0,(a.curr.en||0)-(a.prev.en||0)), w: Math.max(0,(a.curr.w||0)-(a.prev.w||0)), g: Math.max(0,(a.curr.g||0)-(a.prev.g||0)) };
            let mCost = (c.ed*t.el_d)+(c.en*t.el_n)+(c.w*t.w)+(c.g*t.g);
            
            // Custom Counters Calc
            let custCost = 0; let custTxt = "";
            (a.custom_counters || []).forEach(cc => {
                let diff = Math.max(0, cc.curr - cc.prev);
                let cost = diff * cc.price;
                custCost += cost;
                custTxt += `${cc.name}: ${diff} –æ–¥. (${cost.toFixed(0)} –≥—Ä–Ω)\n`;
            });

            let sCost=0, sTxt=""; a.services.forEach(s=>{sCost+=(s.val||0); sTxt+=`${s.name}: ${s.val}\n`});
            let tot = mCost + custCost + sCost + mzkPerApt + (a.debt||0); 
            let bal = tot - (a.paid||0);
            
            const txt = `–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è ${dStr}\n${d.name} - ${a.name}\n\n‚ö°–ï/–ï: ${c.ed}/${c.en} (${((c.ed*t.el_d)+(c.en*t.el_n)).toFixed(0)} –≥—Ä–Ω)\nüíß–í–æ–¥–∞: ${c.w} (${(c.w*t.w).toFixed(0)} –≥—Ä–Ω)\nüî•–ì–∞–∑: ${c.g} (${(c.g*t.g).toFixed(0)} –≥—Ä–Ω)\n${custTxt}üè¢–ú–ó–ö: ${mzkPerApt.toFixed(2)} –≥—Ä–Ω\n${sTxt?'---\n'+sTxt:''}----------------\n–ù–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ: ${(mCost+custCost+sCost+mzkPerApt).toFixed(2)} –≥—Ä–Ω\n–î–û –°–ü–õ–ê–¢–ò: ${tot.toFixed(2)} –≥—Ä–Ω\n${a.paid?`–°–ø–ª–∞—á–µ–Ω–æ: -${a.paid}\n–ó–∞–ª–∏—à–æ–∫: ${bal.toFixed(2)}`:''}\n\n–†–µ–∫–≤—ñ–∑–∏—Ç–∏:\n${d.requisites.map(r=>`${r.name}: ${r.val}`).join('\n')}`;
            this.checks[i] = txt;
            document.getElementById(`badge-${i}`).innerText = Math.round(tot);
            
            let btnClass = 'btn-outline', btnText = '–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏';
            if(a.messenger === 'viber') { btnClass = 'btn-viber'; btnText = 'Viber'; }
            if(a.messenger === 'telegram') { btnClass = 'btn-telegram'; btnText = 'Telegram'; }
            if(a.messenger === 'whatsapp') { btnClass = 'btn-whatsapp'; btnText = 'WhatsApp'; }

            return `<div class="card" style="border-left:4px solid var(--primary); padding:15px;">
                <div style="display:flex;justify-content:space-between; margin-bottom:5px;">
                    <span style="font-weight:bold; font-size:16px;">${a.name}</span>
                    <span style="font-weight:bold; font-size:16px; color:var(--text);">${tot.toFixed(2)} –≥—Ä–Ω</span>
                </div>
                <div style="font-size:12px;color:var(--text-sec);margin-bottom:12px; text-align:right;">–î–æ —Å–ø–ª–∞—Ç–∏: <b>${bal.toFixed(2)}</b></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn ${btnClass} btn-sm" onclick="app.sendCheck(${i})">üí¨ ${btnText}</button>
                    <button class="btn btn-warning btn-sm" onclick="app.sharePDF(${i})">üìÑ PDF</button>
                </div>
            </div>`;
        }).join('');
        document.getElementById('resultModal').style.display='flex';
    }

    async sendCheck(i) {
        const txt = this.checks[i];
        if (!txt) { alert("–ü–æ–º–∏–ª–∫–∞"); return; }
        const a = this.currentData.apartments[i];
        let phone = (a.phone || "").replace(/\D/g,''); 
        if(!phone && a.messenger !== 'telegram') { await this.copyTextToClipboard(txt); alert("–í–∫–∞–∂—ñ—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –∞–±–æ —Ç–µ–∫—Å—Ç —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ."); return; }
        if(phone && phone.startsWith('0')) phone='38'+phone; 
        const encTxt = encodeURIComponent(txt);
        if (a.messenger === 'whatsapp') window.location.href = `https://wa.me/${phone}?text=${encTxt}`;
        else if (a.messenger === 'telegram') window.location.href = `tg://msg?text=${encTxt}`;
        else if (a.messenger === 'viber') { await this.copyTextToClipboard(txt); window.location.href = phone ? `viber://chat?number=%2B${phone}` : `viber://forward?text=${encTxt}`; }
        else { await this.copyTextToClipboard(txt); alert("–¢–µ–∫—Å—Ç —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ"); }
    }
    
    copyTextToClipboard(text) { 
        const ta = document.createElement("textarea"); ta.value = text; 
        document.body.appendChild(ta); ta.select(); 
        document.execCommand('copy'); document.body.removeChild(ta);
    }

    async downloadBackup() { 
        const date = new Date(); 
        const fileName = `Komunalka_Backup_${date.toISOString().slice(0,10)}.txt`; 
        const str = JSON.stringify(this.state); 
        const file = new File([str], fileName, { type: "text/plain" });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try { await navigator.share({ files: [file], title: '–ó–±–µ—Ä–µ–≥—Ç–∏ –±–µ–∫–∞–ø' }); return; } catch (e) {}
        }
        const a = document.createElement('a'); a.href = "data:text/plain;charset=utf-8," + encodeURIComponent(str); 
        a.download = fileName; document.body.appendChild(a); a.click(); a.remove(); 
    }

    loadBackup(inpt) { 
        const f = inpt.files[0]; if(!f) return; 
        if (!confirm("–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏?")) return;
        const r = new FileReader(); 
        r.onload = e => { try { this.state = JSON.parse(e.target.result); this.save(); location.reload(); } catch(x) { alert("–ü–æ–º–∏–ª–∫–∞"); } }; 
        r.readAsText(f); 
    }

    async sharePDF(i) {
        if (typeof html2pdf === 'undefined') { alert('–Ü–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. PDF –Ω–µ –ø—Ä–∞—Ü—é—î.'); return; }
        window.scrollTo(0, 0);
        const a = this.currentData.apartments[i]; const d = this.currentData; const dStr = new Date().toLocaleDateString('uk-UA');
        
        // Std Costs
        const c = { ed: Math.max(0,(a.curr.ed||0)-(a.prev.ed||0)), en: Math.max(0,(a.curr.en||0)-(a.prev.en||0)), w: Math.max(0,(a.curr.w||0)-(a.prev.w||0)), g: Math.max(0,(a.curr.g||0)-(a.prev.g||0)) };
        const cost = { ed: (c.ed*d.tariffs.el_d) + (c.en*d.tariffs.el_n), w: c.w*d.tariffs.w, g: c.g*d.tariffs.g };
        
        // Custom Counters HTML
        let custRows = ""; let custCostTotal = 0;
        (a.custom_counters || []).forEach(cc => {
            let diff = Math.max(0, cc.curr - cc.prev);
            let val = diff * cc.price;
            custCostTotal += val;
            custRows += `<tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:5px;">${cc.name} (${diff} –æ–¥.)</td><td style="padding:5px; text-align:right;">${val.toFixed(2)}</td></tr>`;
        });

        const mzkVal = parseFloat((this.checks[i].match(/–ú–ó–ö: (\d+\.\d+)/) || [0,0])[1]);
        let sRows = a.services.map(s => `<tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:5px;">${s.name}</td><td style="padding:5px;text-align:right;">${s.val.toFixed(2)}</td></tr>`).join('');
        let tot = cost.ed + cost.w + cost.g + custCostTotal + a.services.reduce((s,x)=>s+x.val,0) + mzkVal + (a.debt||0);

        const template = `
        <div style="font-family: 'Inter', sans-serif; color:#1e293b; background:#fff; padding:30px; box-sizing: border-box; width: 100%; text-align: center;">
            <div style="margin-bottom:20px; font-weight: 900; font-size: 20px;">–ö–æ–º—É–Ω–∞–ª–∫<span style="color:#0099ff">–û–±–ª—ñ–∫</span><div style="font-size:12px; margin-top:5px; color:#64748b;">${d.name}</div></div>
            <div style="background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:15px; font-size:14px; text-align: left;">–ü–ª–∞—Ç–Ω–∏–∫: <strong>${a.name}</strong></div>
            <table style="width:100%; border-collapse:collapse; font-size:11px; margin: 0 auto;">
                <tr style="background:#f8fafc; color:#64748b;"><th style="padding:5px; text-align:left;">–ü–æ—Å–ª—É–≥–∞</th><th style="padding:5px; text-align:right;">–°—É–º–∞</th></tr>
                <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:5px; text-align:left;">‚ö° –ï–ª–µ–∫—Ç—Ä–∏–∫–∞</td><td style="padding:5px; text-align:right;">${cost.ed.toFixed(2)}</td></tr>
                <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:5px; text-align:left;">üíß –í–æ–¥–∞</td><td style="padding:5px; text-align:right;">${cost.w.toFixed(2)}</td></tr>
                <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:5px; text-align:left;">üî• –ì–∞–∑</td><td style="padding:5px; text-align:right;">${cost.g.toFixed(2)}</td></tr>
                ${custRows}
                <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:5px; text-align:left;">üè¢ –ú–ó–ö</td><td style="padding:5px; text-align:right;">${mzkVal.toFixed(2)}</td></tr>
                ${sRows}
            </table>
            <div style="text-align:right; margin-top:20px;">
                <div style="font-size:22px; font-weight:bold; color:#0099ff;">${tot.toFixed(2)} –≥—Ä–Ω</div>
                ${a.debt > 0 ? `<div style="font-size:10px; color:#ef4444;">(–í–∫–ª. –±–æ—Ä–≥ ${a.debt})</div>` : ''}
            </div>
            <div style="margin-top:30px; border-top:1px dashed #cbd5e1; padding-top:10px; text-align: left;">
                <div style="font-size:10px; font-weight:bold; color:#64748b; margin-bottom:3px;">–†–ï–ö–í–Ü–ó–ò–¢–ò:</div>
                ${d.requisites.map(r=>`<div style="font-size:10px;">${r.name}: <strong>${r.val}</strong></div>`).join('')}
            </div>
        </div>`;

        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #555; z-index: 99999; display: flex; justify-content: center; overflow: auto; padding: 20px;';
        const container = document.createElement('div');
        container.style.cssText = 'width: 148mm; background: white; margin: 0 auto; box-shadow: 0 0 20px rgba(0,0,0,0.5);'; 
        container.innerHTML = template;
        overlay.appendChild(container); document.body.appendChild(overlay); await new Promise(r => setTimeout(r, 800)); 

        const fileName = `Rahunok_${a.name.replace(/\s/g,'_')}.pdf`;
        const opt = { margin: 0, filename: fileName, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a5' } };
        try { const pdfWorker = html2pdf().set(opt).from(container); const pdfBlob = await pdfWorker.output('blob'); const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
            if (navigator.canShare && navigator.canShare({ files: [file] })) { await navigator.share({ files: [file] }); } else { await pdfWorker.save(); }
        } catch (e) { alert("PDF Error: " + e.message); } finally { document.body.removeChild(overlay); }
    }

    startNewMonth() { 
        if (!confirm("–ó–∞–∫—Ä–∏—Ç–∏ –º—ñ—Å—è—Ü—å?")) return; 
        this.currentData.apartments.forEach(a => { 
            ['ed','en','w','g'].forEach(k=>{if(a.curr[k]){a.prev[k]=a.curr[k];a.curr[k]=0}}); 
            (a.custom_counters||[]).forEach(c=>{if(c.curr){c.prev=c.curr;c.curr=0}});
            a.paid=0; 
        }); 
        this.currentData.groups.forEach(g => { 
            ['ed','en','w','g'].forEach(k=>{if(g.curr[k]){g.prev[k]=g.curr[k];g.curr[k]=0}}); 
            (g.custom_counters||[]).forEach(c=>{if(c.curr){c.prev=c.curr;c.curr=0}});
        }); 
        this.save(); location.reload(); 
    }
    
    renderTariffs() {
        const container = document.getElementById('tariffs-list');
        container.innerHTML = this.TARIFF_PLANS.map(plan => `
            <div class="price-card ${plan.isPopular ? 'popular' : ''} ${plan.isVip ? 'vip' : ''}">
                ${plan.isPopular ? '<div class="price-badge">–•–Ü–¢ üî•</div>' : ''}
                ${plan.isVip ? '<div class="price-badge" style="background:var(--gold)">VIP üëë</div>' : ''}
                <div class="price-title">${plan.name}</div>
                <div class="price-val">${plan.price} –≥—Ä–Ω</div>
                <div class="price-sub">${plan.desc}</div>
                <button class="btn ${plan.isVip ? 'btn-warning' : 'btn-primary'}" onclick="app.initPay('${plan.id}')">–°–ø–ª–∞—Ç–∏—Ç–∏</button>
            </div>
        `).join('');
    }
    initPay(planId) {
        const plan = this.TARIFF_PLANS.find(p => p.id === planId); if(!plan) return;
        this.pendingPayment = plan; document.getElementById('menuModal').style.display = 'none'; document.getElementById('payModal').style.display = 'flex';
        document.getElementById('pay-details').innerText = `${plan.name} ‚Äî ${plan.price} –≥—Ä–Ω`;
        this.validatePayForm();
    }
    validatePayForm() { document.getElementById('btn-do-pay').disabled = !(document.getElementById('pay-contact').value.length > 3); }
    processPayment() { alert("–î—è–∫—É—î–º–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–π–Ω—è—Ç–∞. –û—á—ñ–∫—É–π—Ç–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è."); document.getElementById('payModal').style.display = 'none'; }
    activatePro() { 
        const key = document.getElementById('activation-key').value;
        if(key === "B15sh356pro") { this.state.license = { type: 'vip', exp: '2099-12-31' }; alert("VIP Active"); location.reload(); return; }
        alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –∫–ª—é—á");
    }
}
const app = new App();
</script>
</body>
</html>

