<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–æ–º—É–Ω–∞–ª–∫–û–±–ª—ñ–∫</title>
    <meta name="theme-color" content="#0f172a">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #0099ff;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-sec: #64748b;
            --border: #cbd5e1;
            --input-bg: #ffffff;
            --danger: #ef4444;
            --success: #10b981;
            --header-bg: #ffffff;
            --radius: 16px;
            --viber: #7360f2;
            --telegram: #229ED9;
            --whatsapp: #25D366;
            --gold: #f59e0b;
        }

        body.dark-mode {
            --bg: #0b1121;
            --card: #151e32;
            --text: #f1f5f9;
            --text-sec: #94a3b8;
            --border: #334155;
            --input-bg: #1e293b;
            --header-bg: #151e32;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px;
            padding-bottom: 140px;
            -webkit-tap-highlight-color: transparent;
            line-height: 1.4;
        }

        /* UI Elements */
        .top-menu-bar { display: flex; justify-content: center; gap: 20px; font-size: 12px; font-weight: 700; color: var(--text-sec); margin-bottom: 15px; padding-top: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .top-menu-bar span { cursor: pointer; display: flex; align-items: center; gap: 5px; }

        .brand-header { display: flex; align-items: center; justify-content: center; margin: 5px 0 20px 0; }
        /* –û–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ç–∏–ª—å –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø–∞ */
        .brand-logo-img { max-height: 55px; width: auto; object-fit: contain; border-radius: 12px; }
        .brand-text-fallback { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 26px; color: var(--text); display: none; }
        .brand-text-fallback span { color: var(--primary); }

        .app-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; background: var(--header-bg); padding: 8px 12px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .nav-btn { font-size: 24px; color: var(--primary); padding: 5px; cursor: pointer; }
        .theme-btn { font-size: 20px; background: none; border: none; cursor: pointer; }
        .object-title { font-size: 16px; font-weight: 700; border: none; text-align: center; width: 100%; background: transparent; color: var(--text); text-transform: uppercase; font-family: 'Montserrat', sans-serif; }
        
        .status-badge { font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 6px; text-transform: uppercase; display: inline-block; margin-top: 2px; background: var(--border); color: var(--text-sec); cursor: pointer; }
        .status-pro { background: linear-gradient(135deg, #0099ff, #0066cc); color: white; box-shadow: 0 2px 5px rgba(0,153,255,0.3); }
        .status-vip { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; box-shadow: 0 2px 5px rgba(245,158,11,0.3); }

        .card { background: var(--card); border-radius: var(--radius); padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .section-title { font-size: 11px; color: var(--text-sec); font-weight: 700; text-transform: uppercase; margin: 15px 0 10px 0; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        .col { flex: 1; min-width: 0; }
        label { display: block; font-size: 11px; color: var(--text-sec); margin-bottom: 4px; font-weight: 600; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 12px; font-size: 16px; background: var(--input-bg); color: var(--text); box-sizing: border-box; transition: 0.2s; }
        input:focus { border-color: var(--primary); outline: none; }
        input:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn { display: flex; justify-content: center; align-items: center; width: 100%; padding: 12px; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; text-align: center; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: var(--border); color: var(--text-sec); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--gold); color: white; }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-add { background: rgba(0, 153, 255, 0.1); color: var(--primary); border: 1px dashed var(--primary); margin-top: 10px; }
        .btn-sm { padding: 8px 12px; font-size: 12px; width: auto; }
        
        .btn-viber { background: var(--viber); color: white; border: none; }
        .btn-telegram { background: var(--telegram); color: white; border: none; }
        .btn-whatsapp { background: var(--whatsapp); color: white; border: none; }

        details { margin-bottom: 15px; border: 1px solid var(--border); border-radius: 14px; background: var(--card); overflow: hidden; }
        summary { padding: 15px; background: rgba(0,0,0,0.02); font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; list-style: none; color: var(--text); }
        .content { padding: 20px; border-top: 1px solid var(--border); }
        
        .info-block h4 { margin: 15px 0 5px 0; color: var(--primary); font-size: 14px; }
        .info-block p { font-size: 13px; color: var(--text-sec); margin: 0 0 10px 0; }
        .info-block ul { margin: 0 0 10px 0; padding-left: 20px; font-size: 13px; color: var(--text-sec); }
        .info-block li { margin-bottom: 4px; }

        .sticky-footer { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 10px; display: flex; justify-content: center; gap: 8px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: var(--card); color: var(--text); width: 100%; max-width: 450px; padding: 25px; border-radius: 24px; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: var(--text-sec); }
        
        .custom-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .del-icon { color: var(--danger); font-size: 20px; padding: 0 8px; cursor: pointer; }

        .price-card { border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; background: var(--bg); position: relative; overflow: hidden; }
        .price-card.popular { border-color: var(--primary); background: rgba(0, 153, 255, 0.03); }
        .price-card.vip { border-color: var(--gold); background: rgba(245, 158, 11, 0.05); }
        .price-badge { position: absolute; top: 0; right: 0; background: var(--primary); color: white; font-size: 10px; padding: 3px 8px; border-bottom-left-radius: 8px; font-weight: bold; }
        .price-title { font-size: 16px; font-weight: 900; margin-bottom: 5px; text-transform: uppercase; font-family: 'Montserrat', sans-serif; }
        .price-val { font-size: 20px; font-weight: bold; color: var(--text); margin-bottom: 5px; }
        .price-sub { font-size: 11px; color: var(--text-sec); margin-bottom: 10px; }
        
        .contact-check-badge { display: inline-flex; align-items: center; gap: 5px; font-size: 10px; color: var(--success); background: rgba(16, 185, 129, 0.1); padding: 2px 6px; border-radius: 4px; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="top-menu-bar">
        <span onclick="app.openMenu('info')">‚ÑπÔ∏è –Ü–Ω—Ñ–æ</span>
        <span onclick="app.openMenu('premium')" style="color:var(--primary)">üíé PRO</span>
        <span onclick="app.openMenu('contacts')">üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏</span>
    </div>

    <div class="brand-header">
        <img src="icon.png" alt="–ö–æ–º—É–Ω–∞–ª–∫–û–±–ª—ñ–∫" class="brand-logo-img" onerror="document.querySelector('.brand-text-fallback').style.display='block'; this.style.display='none';">
        <div class="brand-text-fallback">–ö–æ–º—É–Ω–∞–ª–∫<span>–û–±–ª—ñ–∫</span></div>
    </div>

    <div class="app-header">
        <button class="theme-btn" onclick="app.toggleTheme()" id="theme-icon">üåó</button>
        <div class="nav-btn" onclick="app.prevObject()">‚ùÆ</div>
        <div style="flex:1; text-align:center;">
            <input type="text" id="object-title" class="object-title" value="–ú—ñ–π –û–±'—î–∫—Ç" onchange="app.updateObjectName(this.value)" placeholder="–ù–ê–ó–í–ê –û–ë'–Ñ–ö–¢–£">
            <div id="status-badge" class="status-badge" onclick="app.openMenu('premium')">FREE</div>
        </div>
        <div class="nav-btn" onclick="app.addObject()" title="–î–æ–¥–∞—Ç–∏ –æ–±'—î–∫—Ç">+</div>
        <div class="nav-btn" onclick="app.nextObject()">‚ùØ</div>
    </div>
    
    <div id="main-content-wrapper">
        <details>
            <summary>‚öôÔ∏è –¢–∞—Ä–∏—Ñ–∏ —Ç–∞ –†–µ–∫–≤—ñ–∑–∏—Ç–∏</summary>
            <div class="content">
                <div class="section-title">–¢–∞—Ä–∏—Ñ–∏ (–≥—Ä–Ω)</div>
                <div class="row">
                    <div class="col"><label>‚ö° –î–µ–Ω—å</label><input type="number" id="t_ed" onchange="app.setTariff('el_d',this.value)"></div>
                    <div class="col"><label>üåô –ù—ñ—á</label><input type="number" id="t_en" onchange="app.setTariff('el_n',this.value)"></div>
                </div>
                <div class="row">
                    <div class="col"><label>üíß –í–æ–¥–∞</label><input type="number" id="t_w" onchange="app.setTariff('w',this.value)"></div>
                    <div class="col"><label>üî• –ì–∞–∑</label><input type="number" id="t_g" onchange="app.setTariff('g',this.value)"></div>
                </div>
                
                <div class="section-title">–î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–∏—Ç—Ä–∞—Ç–∏ (–ú–ó–ö)</div>
                <div id="extra-tariffs-container"></div>
                <button class="btn btn-add" onclick="app.addExtraTariff()">+ –†—è–¥–æ–∫ –≤–∏—Ç—Ä–∞—Ç</button>
                
                <div class="section-title" style="margin-top:20px;">–ë–∞–Ω–∫—ñ–≤—Å—å–∫—ñ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏</div>
                <div id="requisites-container"></div>
                <button class="btn btn-add" onclick="app.addRequisite()">+ –î–æ–¥–∞—Ç–∏ –∫–∞—Ä—Ç–∫—É/IBAN</button>
            </div>
        </details>

        <div id="groups-container"></div>
        <div style="text-align:center; margin: 20px 0;">
            <button class="btn btn-outline" style="width:auto; display:inline-block; padding:10px 20px;" onclick="app.addGroup()">+ –ì—Ä—É–ø–∞ –ú–ó–ö (–í—Ö—ñ–¥)</button>
        </div>

        <div id="apartments-container"></div>
        
        <div style="text-align:center; margin: 30px 0;">
            <button class="btn btn-primary" style="width:auto; display:inline-block; padding:12px 30px; font-size:16px; box-shadow: 0 4px 15px rgba(0, 153, 255, 0.4);" onclick="app.addApartment()">
                + –î–æ–¥–∞—Ç–∏ –ö–≤–∞—Ä—Ç–∏—Ä—É
            </button>
            <div style="font-size:11px; color:var(--text-sec); margin-top:8px;">–õ—ñ–º—ñ—Ç: <span id="limit-counter">0/2</span></div>
        </div>
    </div>
    
    <div style="height: 120px;"></div>

    <div class="sticky-footer">
        <button class="btn btn-warning" style="flex:1;" onclick="app.downloadBackup()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <button class="btn btn-outline" style="flex:1; border-color:var(--border); color:var(--text);" onclick="document.getElementById('file-input').click()">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
        <button class="btn btn-success" style="flex:1.5;" onclick="app.calculate()">‚úÖ –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
        <input type="file" id="file-input" style="display:none" accept=".json, .txt, application/json, text/plain" onchange="app.loadBackup(this)">
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('resultModal').style.display='none'">&times;</span>
            <h3 style="margin-top:0; text-align:center; font-family:'Montserrat',sans-serif;">–ö–≤–∏—Ç–∞–Ω—Ü—ñ—ó</h3>
            <div id="mzk-info" style="background:var(--bg); padding:12px; border-radius:10px; margin-bottom:20px; font-size:13px; text-align:center; border:1px solid var(--border);"></div>
            <div id="results-list"></div>
            <hr style="margin: 20px 0; border:0; border-top:1px solid var(--border);">
            <button class="btn btn-danger" onclick="app.startNewMonth()">üóì –ó–∞–∫—Ä–∏—Ç–∏ –º—ñ—Å—è—Ü—å</button>
        </div>
    </div>

    <div id="menuModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('menuModal').style.display='none'">&times;</span>
            <h3 style="margin-top:0; text-align:center;" id="menu-title">–ú–µ–Ω—é</h3>
            
            <div id="menu-content-info" style="display:none" class="info-block">
                <p style="text-align:center;"><strong>–ö–æ–º—É–Ω–∞–ª–∫–û–±–ª—ñ–∫ v2.9</strong></p>
                <hr style="border:0; border-top:1px solid var(--border)">
                
                <h4>üè† –û–±'—î–∫—Ç–∏ —Ç–∞ –ö–≤–∞—Ä—Ç–∏—Ä–∏</h4>
                <p>–ù–∞—Ç–∏—Å–∫–∞–π—Ç–µ –Ω–∞ –Ω–∞–∑–≤—É –û–±'—î–∫—Ç—É (–∑–≤–µ—Ä—Ö—É) –∞–±–æ –ö–≤–∞—Ä—Ç–∏—Ä–∏, —â–æ–± –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏ —ó—Ö. –î–æ –∫–æ–∂–Ω–æ–≥–æ –æ–±'—î–∫—Ç—É –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –æ–∫—Ä–µ–º—ñ —Ç–∞—Ä–∏—Ñ–∏.</p>
                
                <h4>üìä –Ø–∫ —Ä–∞—Ö—É—î—Ç—å—Å—è –ú–ó–ö?</h4>
                <p>–ú–ó–ö (–ú—ñ—Å—Ü—è –ó–∞–≥–∞–ª—å–Ω–æ–≥–æ –ö–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è) —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:</p>
                <ul>
                    <li>–ë–µ—Ä–µ—Ç—å—Å—è —Ä—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ –∑–∞–≥–∞–ª—å–Ω–∏–º –ª—ñ—á–∏–ª—å–Ω–∏–∫–æ–º (–í—Ö—ñ–¥–Ω–∞ –≥—Ä—É–ø–∞) —Ç–∞ —Å—É–º–æ—é –≤—Å—ñ—Ö –∫–≤–∞—Ä—Ç–∏—Ä.</li>
                    <li>–¶—è —Ä—ñ–∑–Ω–∏—Ü—è –º–Ω–æ–∂–∏—Ç—å—Å—è –Ω–∞ —Ç–∞—Ä–∏—Ñ (–í—Ç—Ä–∞—Ç–∏).</li>
                    <li>–î–æ–¥–∞—é—Ç—å—Å—è —Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ (–Ω–∞–ø—Ä. –ü—Ä–∏–±–∏—Ä–∞–Ω–Ω—è), —è–∫—ñ –≤–∏ –¥–æ–¥–∞–ª–∏ –≤ –º–µ–Ω—é "–¢–∞—Ä–∏—Ñ–∏".</li>
                    <li>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞ –¥—ñ–ª–∏—Ç—å—Å—è –ø–æ—Ä—ñ–≤–Ω—É –Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä.</li>
                </ul>

                <h4>‚ûï –ü–æ—Å–ª—É–≥–∏ —Ç–∞ –¢–∞—Ä–∏—Ñ–∏</h4>
                <p>–í–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω—ñ –ø–æ—Å–ª—É–≥–∏ –¥–ª—è –∫–æ–∂–Ω–æ—ó –∫–≤–∞—Ä—Ç–∏—Ä–∏ (–Ω–∞–ø—Ä. "–Ü–Ω—Ç–µ—Ä–Ω–µ—Ç") –∞–±–æ –∑–∞–≥–∞–ª—å–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ –Ω–∞ –±—É–¥–∏–Ω–æ–∫.</p>

                <h4>üì§ –ï–∫—Å–ø–æ—Ä—Ç —Ç–∞ –í—ñ–¥–ø—Ä–∞–≤–∫–∞</h4>
                <p>–ü—ñ—Å–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤–∏ –º–æ–∂–µ—Ç–µ: –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ç–µ–∫—Å—Ç –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó –≤ Telegram, Viber, WhatsApp –∞–±–æ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫—Ä–∞—Å–∏–≤–∏–π PDF —Ñ–∞–π–ª.</p>

                <h4>üíæ –î–∞–Ω—ñ —Ç–∞ –ë–µ–∑–ø–µ–∫–∞</h4>
                <p>–í—Å—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –Ω–∞ –≤–∞—à–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó. 
                <br><strong>–ó–±–µ—Ä–µ–≥—Ç–∏:</strong> –°—Ç–≤–æ—Ä—é—î —Ñ–∞–π–ª –±–µ–∫–∞–ø—É.
                <br><strong>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏:</strong> –í—ñ–¥–Ω–æ–≤–ª—é—î –¥–∞–Ω—ñ –∑ —Ñ–∞–π–ª—É.</p>

                <h4>üóì –ó–∞–∫—Ä–∏—Ç—Ç—è –º—ñ—Å—è—Ü—è</h4>
                <p>–ö–Ω–æ–ø–∫–∞ "–ó–∞–∫—Ä–∏—Ç–∏ –º—ñ—Å—è—Ü—å" –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –ø–æ—Ç–æ—á–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –≤ "–ú–∏–Ω—É–ª—ñ" —Ç–∞ –æ–±–Ω—É–ª—è—î –æ–ø–ª–∞—Ç–∏.</p>
            </div>

            <div id="menu-content-premium" style="display:none">
                <p style="font-size:13px; text-align:center; color:var(--text-sec); margin-bottom:15px;">–û–±–µ—Ä—ñ—Ç—å —Å–≤—ñ–π —Ç–∞—Ä–∏—Ñ–Ω–∏–π –ø–ª–∞–Ω:</p>
                <div id="tariffs-list"></div>
                <div style="margin-top:20px; padding-top:15px; border-top:1px dashed var(--border);">
                    <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">–í–∂–µ –º–∞—î—Ç–µ –∫–ª—é—á?</div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="activation-key" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó">
                        <button class="btn btn-primary" style="width:auto;" onclick="app.activatePro()">OK</button>
                    </div>
                </div>
            </div>

            <div id="menu-content-contacts" style="display:none">
                <div style="text-align:center;">
                    <p>–í–∏–Ω–∏–∫–ª–∏ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó?</p>
                    <p style="font-weight:bold; margin-bottom:5px;">Telegram –ü—ñ–¥—Ç—Ä–∏–º–∫–∞:</p>
                    <a href="https://t.me/comunalco" target="_blank" class="btn btn-telegram" style="text-decoration:none; margin-bottom:15px;">@comunalco</a>
                    
                    <p style="font-weight:bold; margin-bottom:5px;">Email:</p>
                    <a href="mailto:support@comunalco.com" class="btn btn-outline" style="text-decoration:none; color:var(--text); border-color:var(--border)">support@comunalco.com</a>
                    
                    <p style="font-size:11px; color:var(--text-sec); margin-top:20px;">–ú–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ –ø—Ä–æ—Ç—è–≥–æ–º 24 –≥–æ–¥–∏–Ω.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="payModal" class="modal" style="z-index: 2100;">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('payModal').style.display='none'">&times;</span>
            <h3 style="margin-top:0; text-align:center;">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –ø—ñ–¥–ø–∏—Å–∫–∏</h3>
            <div id="pay-details" style="text-align:center; font-weight:bold; margin-bottom:15px; color:var(--primary);"></div>
            
            <label>–í–∞—à Telegram (–¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–ª—é—á–∞)</label>
            <input type="text" id="pay-contact" placeholder="@username –∞–±–æ –Ω–æ–º–µ—Ä" oninput="app.validatePayForm()">
            
            <label style="margin-top:10px;">Email (—Ä–µ–∑–µ—Ä–≤)</label>
            <input type="email" id="pay-email" placeholder="mail@example.com" oninput="app.validatePayForm()">

            <div style="margin: 15px 0;">
                 <button class="btn btn-outline btn-sm" onclick="alert('–¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ! (–°–∏–º—É–ª—è—Ü—ñ—è)')">üîî –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–≤'—è–∑–æ–∫</button>
                 <div id="test-msg-status" style="font-size:10px; color:var(--success); display:none; text-align:center; margin-top:5px;">–ó–≤'—è–∑–æ–∫ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ ‚úÖ</div>
            </div>

            <button id="btn-do-pay" class="btn btn-success" disabled onclick="app.processPayment()">üí≥ –°–ø–ª–∞—Ç–∏—Ç–∏ —Ç–∞ –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–ª—é—á</button>
            <div style="font-size:10px; color:var(--text-sec); text-align:center; margin-top:10px;">–î–∞–Ω—ñ –±—É–¥—É—Ç—å –ø–µ—Ä–µ–¥–∞–Ω—ñ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó</div>
        </div>
    </div>
<script>
class App {
    constructor() {
        // --- –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø –õ–Ü–ú–Ü–¢–Ü–í ---
        this.LIMITS = { free: 2, standard: 10, pro: 9999, vip: 9999 };
        
        // --- –¢–ê–†–ò–§–ù–Ü –ü–õ–ê–ù–ò ---
        this.TARIFF_PLANS = [
            { id: 'std_6', name: '–†–∞–Ω—Ç—å—î (6 –º—ñ—Å)', limit: 10, price: 300, desc: '–î–æ 10 –∫–≤–∞—Ä—Ç–∏—Ä. 50 –≥—Ä–Ω/–º—ñ—Å' },
            { id: 'std_12', name: '–†–∞–Ω—Ç—å—î (1 —Ä—ñ–∫)', limit: 10, price: 499, desc: '–î–æ 10 –∫–≤–∞—Ä—Ç–∏—Ä. –í–∏–≥–æ–¥–∞ 17%', isPopular: true },
            { id: 'pro_6', name: 'PRO (6 –º—ñ—Å)', limit: 9999, price: 750, desc: '–ë–µ–∑–ª—ñ–º—ñ—Ç. –î–ª—è –±—ñ–∑–Ω–µ—Å—É.' },
            { id: 'pro_12', name: 'PRO (1 —Ä—ñ–∫)', limit: 9999, price: 1190, desc: '–ë–µ–∑–ª—ñ–º—ñ—Ç. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –≤–∏–≥–æ–¥–∞.' },
            { id: 'vip', name: 'LIFETIME', limit: 9999, price: 2900, desc: '–ù–∞–∑–∞–≤–∂–¥–∏. –û–ø–ª–∞—Ç–∞ 1 —Ä–∞–∑.', isVip: true }
        ];

        this.state = { 
            license: { type: 'free', exp: null, contact: '' },
            currentObjIdx: 0, 
            objects: [] 
        };
        this.checks = {};
        this.STORAGE_KEY = 'komunalka_v29_pro'; 
        this.pendingPayment = null; 
        this.init();
    }
    
    init() { 
        this.load(); 
        this.initTheme(); 
        this.renderAll(); 
        this.updateStatus(); 
    }
    
    // --- –õ–û–ì–Ü–ö–ê –ú–ï–ù–Æ –¢–ê –û–ü–õ–ê–¢–ò ---

    openMenu(id) {
        document.getElementById('menuModal').style.display='flex';
        // –•–æ–≤–∞—î–º–æ –≤—Å—ñ —Å–µ–∫—Ü—ñ—ó
        ['info','premium','contacts'].forEach(k => document.getElementById('menu-content-'+k).style.display='none');
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω—É
        const el = document.getElementById('menu-content-'+id);
        if(el) el.style.display='block';

        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        const titles = { info: '‚ÑπÔ∏è –Ü–Ω—Ñ–æ', premium: 'üíé –ú–∞–≥–∞–∑–∏–Ω', contacts: 'üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏' };
        document.getElementById('menu-title').innerText = titles[id] || '–ú–µ–Ω—é';

        // –Ø–∫—â–æ –≤—ñ–¥–∫—Ä–∏–ª–∏ –ø—Ä–µ–º—ñ—É–º - —Ä–µ–Ω–¥–µ—Ä–∏–º–æ —Ç–∞—Ä–∏—Ñ–∏
        if(id === 'premium') this.renderTariffs();
    }

    renderTariffs() {
        const container = document.getElementById('tariffs-list');
        container.innerHTML = this.TARIFF_PLANS.map(plan => `
            <div class="price-card ${plan.isPopular ? 'popular' : ''} ${plan.isVip ? 'vip' : ''}">
                ${plan.isPopular ? '<div class="price-badge">–•–Ü–¢ üî•</div>' : ''}
                ${plan.isVip ? '<div class="price-badge" style="background:var(--gold)">VIP üëë</div>' : ''}
                <div class="price-title">${plan.name}</div>
                <div class="price-val">${plan.price} –≥—Ä–Ω</div>
                <div class="price-sub">${plan.desc}</div>
                <button class="btn ${plan.isVip ? 'btn-warning' : 'btn-primary'}" onclick="app.initPay('${plan.id}')">–°–ø–ª–∞—Ç–∏—Ç–∏</button>
            </div>
        `).join('');
    }

    initPay(planId) {
        const plan = this.TARIFF_PLANS.find(p => p.id === planId);
        if(!plan) return;
        
        this.pendingPayment = plan;
        document.getElementById('menuModal').style.display = 'none';
        document.getElementById('payModal').style.display = 'flex';
        document.getElementById('pay-details').innerText = `${plan.name} ‚Äî ${plan.price} –≥—Ä–Ω`;
        this.validatePayForm();
    }

    validatePayForm() {
        const contact = document.getElementById('pay-contact').value;
        const email = document.getElementById('pay-email').value;
        const btn = document.getElementById('btn-do-pay');
        
        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è: –º–∞—î –±—É—Ç–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π —Ö–æ—á–∞ –± –∫–æ–Ω—Ç–∞–∫—Ç
        if(contact.length > 3 || email.length > 5) {
            btn.disabled = false;
        } else {
            btn.disabled = true;
        }
    }

    processPayment() {
        const contact = document.getElementById('pay-contact').value;
        const email = document.getElementById('pay-email').value;
        const plan = this.pendingPayment;
        
        if(!plan) return;

        // –°–∏–º—É–ª—è—Ü—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        const msg = encodeURIComponent(`–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è: ${plan.name}\n–°—É–º–∞: ${plan.price} –≥—Ä–Ω\n–ö–ª—ñ—î–Ω—Ç: ${contact} / ${email}`);
        
        if(confirm(`–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è "${plan.name}"?\n–ú–∏ –∑–≤'—è–∂–µ–º–æ—Å—è –∑ –≤–∞–º–∏ —á–µ—Ä–µ–∑ ${contact || email} –¥–ª—è –æ–ø–ª–∞—Ç–∏.`)) {
            alert(`–î—è–∫—É—î–º–æ! –ó–∞—è–≤–∫—É –ø—Ä–∏–π–Ω—è—Ç–æ.\n\n–í–∞—à —Ç–∏–º—á–∞—Å–æ–≤–∏–π –Ω–æ–º–µ—Ä: #${Date.now().toString().slice(-6)}\n–û—á—ñ–∫—É–π—Ç–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.`);
            document.getElementById('payModal').style.display = 'none';
        }
    }

    activatePro() {
        const keyInput = document.getElementById('activation-key').value.trim();
        if (!keyInput) return;

        // --- –ú–ê–ô–°–¢–ï–† –ö–õ–Æ–ß ---
        if (keyInput === "B15sh356pro") {
            this.state.license = { type: 'vip', exp: '2099-12-31', contact: 'Master' };
            this.save();
            alert("üëë –†–µ–∂–∏–º –†–û–ó–†–û–ë–ù–ò–ö–ê (VIP) –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ!\n–í—Å—ñ –ª—ñ–º—ñ—Ç–∏ –∑–Ω—è—Ç–æ.");
            location.reload();
            return;
        }
        // --------------------

        try {
            // –†–æ–∑–±—ñ—Ä Base64 JSON –∫–ª—é—á–∞
            const jsonStr = atob(keyInput);
            const data = JSON.parse(jsonStr);
            
            if (!data.t || !data.e) throw new Error("Format");

            const expDate = new Date(data.e);
            if (expDate < new Date()) throw new Error("Expired");

            let typeMap = { 'std': 'standard', 'pro': 'pro', 'vip': 'vip' };
            
            this.state.license = { 
                type: typeMap[data.t] || 'free', 
                exp: data.e 
            };
            
            this.save();
            alert(`–ö–ª—é—á –ø—Ä–∏–π–Ω—è—Ç–æ!\n–¢–∞—Ä–∏—Ñ: ${this.state.license.type.toUpperCase()}\n–î—ñ—î –¥–æ: ${data.e}`);
            location.reload();

        } catch (e) {
            alert("–ü–æ–º–∏–ª–∫–∞: –ù–µ–≤—ñ—Ä–Ω–∏–π –∞–±–æ –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π –∫–ª—é—á.");
        }
    }

    checkLimit() {
        const cnt = this.state.objects.reduce((s,o)=>s+o.apartments.length,0);
        const lic = this.state.license || {type:'free'};
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–µ—Ä–º—ñ–Ω—É –¥—ñ—ó –ª—ñ—Ü–µ–Ω–∑—ñ—ó
        if (lic.exp && new Date(lic.exp) < new Date()) {
            this.state.license.type = 'free'; 
            this.save();
            alert("–¢–µ—Ä–º—ñ–Ω –¥—ñ—ó –≤–∞—à–æ—ó –ª—ñ—Ü–µ–Ω–∑—ñ—ó –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è. –í–∏ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ñ –Ω–∞ —Ç–∞—Ä–∏—Ñ FREE.");
            location.reload(); 
            return false;
        }

        const limit = this.LIMITS[lic.type] || this.LIMITS.free;
        if(cnt >= limit) {
            alert(`–î–æ—Å—è–≥–Ω—É—Ç–æ –ª—ñ–º—ñ—Ç —Ç–∞—Ä–∏—Ñ—É ${lic.type.toUpperCase()} (${limit} –∫–≤).\n–î–ª—è –∑–±—ñ–ª—å—à–µ–Ω–Ω—è –ª—ñ–º—ñ—Ç—É –ø–µ—Ä–µ–π–¥—ñ—Ç—å –≤ –º–µ–Ω—é PRO.`);
            this.openMenu('premium');
            return false;
        }
        return true;
    }

    // --- –ë–ê–ó–û–í–Ü –ú–ï–¢–û–î–ò ---

    initTheme() { 
        const isDark = localStorage.getItem('theme')==='dark';
        if(isDark) document.body.classList.add('dark-mode'); 
        const icon = document.getElementById('theme-icon');
        if(icon) icon.innerText = isDark ? '‚òÄÔ∏è' : 'üåë';
    }
    
    toggleTheme() { 
        document.body.classList.toggle('dark-mode'); 
        localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); 
        this.initTheme(); 
    }

    createDefaultObject(name) {
        return {
            id: Date.now(), name: name || "–ú—ñ–π –û–±'—î–∫—Ç",
            tariffs: { el_d: 4.32, el_n: 2.16, w: 30.0, g: 8.0 }, 
            extra_tariffs: [], 
            requisites: [{ id: 1, name: "–ö–∞—Ä—Ç–∫–∞", val: "" }],
            groups: [{ id: 1, name: "–í—Ö—ñ–¥–Ω–∞ –ì—Ä—É–ø–∞", prev: { ed: 0, en: 0, w: 0, g: 0 }, curr: { ed: 0, en: 0, w: 0, g: 0 }, services: [] }],
            apartments: [{ id: 1, name: "–ö–≤. 1", group_id: 1, messenger: 'viber', email: '', phone: '', prev: { ed: 0, en: 0, w: 0, g: 0 }, curr: { ed: 0, en: 0, w: 0, g: 0 }, services: [], paid: 0, debt: 0 }]
        };
    }

    load() { 
        const d = localStorage.getItem(this.STORAGE_KEY); 
        if (d) { 
            try { 
                this.state = JSON.parse(d); 
                if(!this.state.license) this.state.license = { type: 'free', exp: null };
                if(!this.state.objects.length) this.state.objects=[this.createDefaultObject()]; 
            } catch(e) { this.state.objects=[this.createDefaultObject()]; } 
        } else { this.state.objects=[this.createDefaultObject()]; } 
        
        if(this.state.currentObjIdx >= this.state.objects.length) this.state.currentObjIdx=0; 
    }
    
    save() { localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.state)); this.updateStatus(); }
    get currentData() { return this.state.objects[this.state.currentObjIdx]; }
    
    updateObjectName(v) { this.currentData.name = v; this.save(); }
    
    addObject() { 
        this.state.objects.push(this.createDefaultObject(`–û–±'—î–∫—Ç ${this.state.objects.length+1}`)); 
        this.state.currentObjIdx=this.state.objects.length-1; 
        this.save(); this.renderAll(); 
    }
    
    prevObject() { if(this.state.currentObjIdx>0){this.state.currentObjIdx--; this.save(); this.renderAll();} }
    nextObject() { if(this.state.currentObjIdx<this.state.objects.length-1){this.state.currentObjIdx++; this.save(); this.renderAll();} }
    
    updateStatus() {
        const cnt = this.state.objects.reduce((s,o)=>s+o.apartments.length,0);
        const bad = document.getElementById('status-badge');
        const lim = document.getElementById('limit-counter');
        const lic = this.state.license || {type:'free'};
        
        let limit = this.LIMITS[lic.type] || 2;
        let labels = { free: 'FREE', standard: 'RENTIER', pro: 'PRO', vip: 'VIP' };
        let classes = { free: 'status-badge', standard: 'status-badge status-pro', pro: 'status-badge status-pro', vip: 'status-badge status-vip' };

        if(lic.exp && new Date(lic.exp) < new Date()) {
            bad.innerText = "EXPIRED";
            bad.className = "status-badge";
            lim.innerText = `${cnt}/${this.LIMITS.free}`;
        } else {
            bad.innerText = labels[lic.type];
            bad.className = classes[lic.type];
            lim.innerText = limit > 1000 ? "‚àû" : `${cnt}/${limit}`;
        }
    }

    addApartment() { 
        if(!this.checkLimit()) return;
        this.currentData.apartments.push({id:Date.now(), name:`–ö–≤. ${this.currentData.apartments.length+1}`, group_id:1, messenger:'viber', email:'', phone:'', prev:{}, curr:{}, services:[], paid:0, debt:0}); 
        this.save(); this.renderApartments(); 
        this.updateStatus(); 
    }
    renderAll() {
        document.getElementById('object-title').value = this.currentData.name;
        
        // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞—Ä–∏—Ñ—ñ–≤
        ['ed','en','w','g'].forEach(k => { 
            const el = document.getElementById('t_'+k); 
            const map = {ed:'el_d', en:'el_n', w:'w', g:'g'};
            if(el) el.value = this.currentData.tariffs[map[k]]; 
        });

        this.renderExtraTariffs(); 
        this.renderRequisites(); 
        this.renderGroups(); 
        this.renderApartments();
    }
    
    renderExtraTariffs() { 
        document.getElementById('extra-tariffs-container').innerHTML = this.currentData.extra_tariffs.map((t, i) => 
            `<div class="custom-row">
                <input type="text" value="${t.name}" placeholder="–ù–∞–∑–≤–∞ –ø–æ—Å–ª—É–≥–∏" onchange="app.updateExtraTariff(${i}, 'name', this.value)">
                <input type="number" value="${t.val}" placeholder="–¶—ñ–Ω–∞" onchange="app.updateExtraTariff(${i}, 'val', this.value)">
                <span class="del-icon" onclick="app.delExtraTariff(${i})">&times;</span>
            </div>`
        ).join(''); 
    }

    renderRequisites() { 
        document.getElementById('requisites-container').innerHTML = this.currentData.requisites.map((r, i) => 
            `<div class="custom-row">
                <input type="text" value="${r.name}" placeholder="–ë–∞–Ω–∫" onchange="app.updateReq(${i}, 'name', this.value)">
                <input type="text" value="${r.val}" placeholder="IBAN/–ö–∞—Ä—Ç–∫–∞" onchange="app.updateReq(${i}, 'val', this.value)">
                <span class="del-icon" onclick="app.delReq(${i})">&times;</span>
            </div>`
        ).join(''); 
    }
    
    renderGroups() { 
        document.getElementById('groups-container').innerHTML = this.currentData.groups.map((g, i) => `
        <div class="card" style="border-left: 4px solid var(--text-sec);">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:700;">
                <span contenteditable="true" onblur="app.updateGroup(${i},'name',this.innerText)" style="border-bottom:1px dashed var(--border)">${g.name}</span>
                <span class="del-icon" onclick="app.delGroup(${i})">&times;</span>
            </div>
            ${this.renderMR(i,g,'prev','‚ö° –í—Ö—ñ–¥ –î–µ–Ω—å','ed')} ${this.renderMR(i,g,'prev','üåô –í—Ö—ñ–¥ –ù—ñ—á','en')}
            ${this.renderMR(i,g,'prev','üíß –í—Ö—ñ–¥ –í–æ–¥–∞','w')} ${this.renderMR(i,g,'prev','üî• –í—Ö—ñ–¥ –ì–∞–∑','g')}
            
            <div style="margin-top:10px; border-top:1px dashed var(--border); padding-top:10px;">
                <div style="font-size:11px; font-weight:700; color:var(--text-sec); margin-bottom:5px;">–°–ü–Ü–õ–¨–ù–Ü –ü–û–°–õ–£–ì–ò (–ú–ó–ö)</div>
                ${(g.services || []).map((s,si)=>`
                    <div class="custom-row">
                        <input type="text" value="${s.name}" placeholder="–ù–∞–∑–≤–∞ (–Ω–∞–ø—Ä. –û—Ö–æ—Ä–æ–Ω–∞)" onchange="app.updateGS(${i},${si},'name',this.value)">
                        <input type="number" value="${s.val}" placeholder="–°—É–º–∞" onchange="app.updateGS(${i},${si},'val',this.value)">
                        <span class="del-icon" onclick="app.delGS(${i},${si})">&times;</span>
                    </div>
                `).join('')}
                <button class="btn btn-add" onclick="app.addGS(${i})">+ –î–æ–¥–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É</button>
            </div>
        </div>`).join(''); 
    }

    renderApartments() { 
        document.getElementById('apartments-container').innerHTML = this.currentData.apartments.map((a, i) => { 
            return `<details style="border-left: 4px solid var(--primary)">
            <summary>
                <div>üö™ <span contenteditable="true" onclick="event.preventDefault()" onblur="app.updateApt(${i},'name',this.innerText)" style="font-weight:700">${a.name}</span> <span style="font-size:12px; opacity:0.7" id="badge-${i}"></span></div>
                <span class="del-icon" onclick="app.delApt(${i})">&times;</span>
            </summary>
            <div class="content">
                <div class="row">
                    <div class="col" style="flex:0.6"><label>–ú–µ—Å–µ–Ω–¥–∂–µ—Ä</label><select onchange="app.updateApt(${i},'messenger',this.value)"><option value="viber" ${a.messenger==='viber'?'selected':''}>Viber</option><option value="whatsapp" ${a.messenger==='whatsapp'?'selected':''}>WhatsApp</option><option value="telegram" ${a.messenger==='telegram'?'selected':''}>Telegram</option></select></div>
                    <div class="col"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="tel" value="${a.phone||''}" placeholder="380..." oninput="app.updateApt(${i},'phone',this.value)"></div>
                </div>
                <div class="row">
                    <div class="col"><label>Email</label><input type="email" value="${a.email||''}" placeholder="email@..." oninput="app.updateApt(${i},'email',this.value)"></div>
                </div>
                <div class="section-title">–õ—ñ—á–∏–ª—å–Ω–∏–∫–∏</div>
                ${this.renderMR(i,a,'apt','‚ö° –ï/–ï –î–µ–Ω—å','ed')} ${this.renderMR(i,a,'apt','üåô –ï/–ï –ù—ñ—á','en')}
                ${this.renderMR(i,a,'apt','üíß –í–æ–¥–∞','w')} ${this.renderMR(i,a,'apt','üî• –ì–∞–∑','g')}
                <button class="btn btn-add" onclick="app.addAS(${i})">+ –Ü–Ω–¥–∏–≤. –ø–æ—Å–ª—É–≥–∞</button>
                <div id="a-serv-${i}">${a.services.map((s,si)=>`<div class="custom-row"><input type="text" value="${s.name}" placeholder="–ù–∞–∑–≤–∞" onchange="app.updateAS(${i},${si},'name',this.value)"><input type="number" value="${s.val}" placeholder="–°—É–º–∞" onchange="app.updateAS(${i},${si},'val',this.value)"><span class="del-icon" onclick="app.delAS(${i},${si})">&times;</span></div>`).join('')}</div>
                <div class="section-title">–ë–∞–ª–∞–Ω—Å</div>
                <div class="row">
                    <div class="col"><label>–ë–æ—Ä–≥</label><input type="number" value="${a.debt||0}" onchange="app.updateApt(${i},'debt',this.value)"></div>
                    <div class="col"><label style="color:var(--success)">–°–ø–ª–∞—á–µ–Ω–æ</label><input type="number" value="${a.paid||''}" placeholder="0.00" onchange="app.updateApt(${i},'paid',this.value)" style="border-color:var(--success)"></div>
                </div>
            </div></details>`; 
        }).join(''); 
    }

    renderMR(i, obj, mode, label, key) { 
        const p = mode==='prev'?obj.prev[key]:obj.prev[key]; 
        const c = mode==='prev'?obj.curr[key]:obj.curr[key]; 
        const fn = mode==='prev'?`app.updateGroupMetric(${i},`:`app.updateAptMetric(${i},`; 
        return `<div class="row" style="align-items:center;">
            <div class="col" style="flex:0.6"><span style="font-size:13px; font-weight:600;">${label}</span></div>
            <div class="col"><input type="number" placeholder="–ë—É–ª–æ" value="${p||0}" onchange="${fn}'prev','${key}',this.value)" style="background:var(--bg)"></div>
            <div class="col"><input type="number" placeholder="–°—Ç–∞–ª–æ" value="${c||0}" onchange="${fn}'curr','${key}',this.value)"></div>
        </div>`; 
    }

    // --- –û–ù–û–í–õ–ï–ù–ù–Ø –î–ê–ù–ò–• ---
    setTariff(k,v) { this.currentData.tariffs[k]=parseFloat(v); this.save(); }
    addExtraTariff(){this.currentData.extra_tariffs.push({name:"",val:0});this.save();this.renderExtraTariffs();}
    updateExtraTariff(i,k,v){this.currentData.extra_tariffs[i][k]=k==='val'?parseFloat(v):v;this.save();}
    delExtraTariff(i){if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏?")){this.currentData.extra_tariffs.splice(i,1);this.save();this.renderExtraTariffs();}}
    
    addRequisite(){this.currentData.requisites.push({name:"",val:""});this.save();this.renderRequisites();}
    updateReq(i,k,v){this.currentData.requisites[i][k]=v;this.save();}
    delReq(i){if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏?")){this.currentData.requisites.splice(i,1);this.save();this.renderRequisites();}}
    
    updateGroup(i,k,v){this.currentData.groups[i][k]=v;this.save();}
    updateGroupMetric(i,t,k,v){this.currentData.groups[i][t][k]=parseFloat(v);this.save();}
    addGroup(){this.currentData.groups.push({id:Date.now(),name:"–ì—Ä—É–ø–∞ –ú–ó–ö",prev:{},curr:{},services:[]});this.save();this.renderGroups();}
    delGroup(i){if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≥—Ä—É–ø—É?")){this.currentData.groups.splice(i,1);this.save();this.renderGroups();}}
    
    addGS(i){ if(!this.currentData.groups[i].services) this.currentData.groups[i].services = []; this.currentData.groups[i].services.push({name:"",val:0}); this.save(); this.renderGroups(); }
    updateGS(gi,si,k,v){ this.currentData.groups[gi].services[si][k]=k==='val'?parseFloat(v):v; this.save(); }
    delGS(gi,si){ this.currentData.groups[gi].services.splice(si,1); this.save(); this.renderGroups(); }

    updateApt(i,k,v){this.currentData.apartments[i][k]=(k==='debt'||k==='paid')?parseFloat(v):v;this.save();}
    updateAptMetric(i,t,k,v){this.currentData.apartments[i][t][k]=parseFloat(v);this.save();}
    addAS(i){this.currentData.apartments[i].services.push({name:"",val:0});this.save();this.renderApartments();}
    updateAS(ai,si,k,v){this.currentData.apartments[ai].services[si][k]=k==='val'?parseFloat(v):v;this.save();}
    delAS(ai,si){this.currentData.apartments[ai].services.splice(si,1);this.save();this.renderApartments();}
    delApt(i){if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É?")){this.currentData.apartments.splice(i,1);this.save();this.renderApartments(); this.updateStatus();}}

    // --- –†–û–ó–†–ê–•–£–ù–ö–ò ---
    calculate() {
        const d = this.currentData; const t = d.tariffs;
        let totalIn={ed:0,en:0,w:0,g:0}, gServSum=0, totalApts={ed:0,en:0,w:0,g:0};
        
        d.groups.forEach(g => { 
            totalIn.ed += Math.max(0,(g.curr.ed||0)-(g.prev.ed||0)); 
            totalIn.en += Math.max(0,(g.curr.en||0)-(g.prev.en||0)); 
            totalIn.w += Math.max(0,(g.curr.w||0)-(g.prev.w||0)); 
            totalIn.g += Math.max(0,(g.curr.g||0)-(g.prev.g||0)); 
            if(g.services) g.services.forEach(s => gServSum += (s.val||0));
        });
        
        d.apartments.forEach(a => { 
            totalApts.ed += Math.max(0,(a.curr.ed||0)-(a.prev.ed||0)); 
            totalApts.en += Math.max(0,(a.curr.en||0)-(a.prev.en||0)); 
            totalApts.w += Math.max(0,(a.curr.w||0)-(a.prev.w||0)); 
            totalApts.g += Math.max(0,(a.curr.g||0)-(a.prev.g||0)); 
        });
        
        d.extra_tariffs.forEach(et => gServSum += (et.val || 0));

        let mzk = { ed: Math.max(0,totalIn.ed-totalApts.ed), en: Math.max(0,totalIn.en-totalApts.en), w: Math.max(0,totalIn.w-totalApts.w), g: Math.max(0,totalIn.g-totalApts.g) };
        let mzkCost = (mzk.ed*t.el_d) + (mzk.en*t.el_n) + (mzk.w*t.w) + (mzk.g*t.g) + gServSum;
        let mzkPerApt = d.apartments.length ? mzkCost/d.apartments.length : 0;
        
        document.getElementById('mzk-info').innerHTML = `<div>–ú–ó–ö –í—Å—å–æ–≥–æ: <b>${mzkCost.toFixed(2)}</b> –≥—Ä–Ω | –ù–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É: <b>${mzkPerApt.toFixed(2)}</b> –≥—Ä–Ω</div>`;
        const dStr = new Date().toLocaleDateString('uk-UA');
        
        document.getElementById('results-list').innerHTML = d.apartments.map((a, i) => {
            const c = { ed: Math.max(0,(a.curr.ed||0)-(a.prev.ed||0)), en: Math.max(0,(a.curr.en||0)-(a.prev.en||0)), w: Math.max(0,(a.curr.w||0)-(a.prev.w||0)), g: Math.max(0,(a.curr.g||0)-(a.prev.g||0)) };
            let mCost = (c.ed*t.el_d)+(c.en*t.el_n)+(c.w*t.w)+(c.g*t.g);
            let sCost=0, sTxt=""; a.services.forEach(s=>{sCost+=(s.val||0); sTxt+=`${s.name}: ${s.val}\n`});
            let tot = mCost + sCost + mzkPerApt + (a.debt||0); 
            let bal = tot - (a.paid||0);
            
            const txt = `–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è ${dStr}\n${d.name} - ${a.name}\n\n‚ö°–ï/–ï: ${c.ed}/${c.en} (${((c.ed*t.el_d)+(c.en*t.el_n)).toFixed(0)} –≥—Ä–Ω)\nüíß–í–æ–¥–∞: ${c.w} (${(c.w*t.w).toFixed(0)} –≥—Ä–Ω)\nüî•–ì–∞–∑: ${c.g} (${(c.g*t.g).toFixed(0)} –≥—Ä–Ω)\nüè¢–ú–ó–ö: ${mzkPerApt.toFixed(2)} –≥—Ä–Ω\n${sTxt?'---\n'+sTxt:''}----------------\n–ù–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ: ${(mCost+sCost+mzkPerApt).toFixed(2)} –≥—Ä–Ω\n–î–û –°–ü–õ–ê–¢–ò: ${tot.toFixed(2)} –≥—Ä–Ω\n${a.paid?`–°–ø–ª–∞—á–µ–Ω–æ: -${a.paid}\n–ó–∞–ª–∏—à–æ–∫: ${bal.toFixed(2)}`:''}\n\n–†–µ–∫–≤—ñ–∑–∏—Ç–∏:\n${d.requisites.map(r=>`${r.name}: ${r.val}`).join('\n')}`;
            this.checks[i] = txt;
            document.getElementById(`badge-${i}`).innerText = Math.round(tot);
            
            let btnClass = 'btn-outline', btnText = '–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏';
            if(a.messenger === 'viber') { btnClass = 'btn-viber'; btnText = 'Viber'; }
            if(a.messenger === 'telegram') { btnClass = 'btn-telegram'; btnText = 'Telegram'; }
            if(a.messenger === 'whatsapp') { btnClass = 'btn-whatsapp'; btnText = 'WhatsApp'; }

            return `<div class="card" style="border-left:4px solid var(--primary); padding:15px;">
                <div style="display:flex;justify-content:space-between; margin-bottom:5px;">
                    <span style="font-weight:bold; font-size:16px;">${a.name}</span>
                    <span style="font-weight:bold; font-size:16px; color:var(--text);">${tot.toFixed(2)} –≥—Ä–Ω</span>
                </div>
                <div style="font-size:12px;color:var(--text-sec);margin-bottom:12px; text-align:right;">–î–æ —Å–ø–ª–∞—Ç–∏: <b>${bal.toFixed(2)}</b></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn ${btnClass} btn-sm" onclick="app.sendCheck(${i})">üí¨ ${btnText}</button>
                    <button class="btn btn-warning btn-sm" onclick="app.sharePDF(${i})">üìÑ PDF / –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                </div>
            </div>`;
        }).join('');
        document.getElementById('resultModal').style.display='flex';
    }

    async sendCheck(i) {
        const txt = this.checks[i];
        if (!txt) { alert("–ü–æ–º–∏–ª–∫–∞ –¥–∞–Ω–∏—Ö –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó"); return; }
        
        const a = this.currentData.apartments[i];
        let phone = (a.phone || "").replace(/\D/g,''); 
        
        if(!phone && a.messenger !== 'telegram') { 
             alert("–í–∫–∞–∂—ñ—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –∫–≤–∞—Ä—Ç–∏—Ä–∏ –∞–±–æ —Å–∫–æ–ø—ñ—é–π—Ç–µ —Ç–µ–∫—Å—Ç."); 
             await this.copyTextToClipboard(txt); 
             return; 
        }
        if(phone && phone.startsWith('0')) phone='38'+phone; 
        
        const encTxt = encodeURIComponent(txt);
        
        if (a.messenger === 'whatsapp') window.location.href = `https://wa.me/${phone}?text=${encTxt}`;
        else if (a.messenger === 'telegram') {
            // FIX: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ tg://msg –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç—É –±–µ–∑ –∑–∞–π–≤–∏—Ö –ø–æ—Å–∏–ª–∞–Ω—å
            window.location.href = `tg://msg?text=${encTxt}`;
        }
        else if (a.messenger === 'viber') { 
            await this.copyTextToClipboard(txt);
            let viberUrl = phone ? `viber://chat?number=%2B${phone}` : `viber://forward?text=${encTxt}`;
            window.location.href = viberUrl;
        }
        else { await this.copyTextToClipboard(txt); alert("–¢–µ–∫—Å—Ç —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É"); }
    }
    
    copyTextToClipboard(text) { 
        const ta = document.createElement("textarea"); ta.value = text; 
        document.body.appendChild(ta); ta.select(); 
        document.execCommand('copy'); document.body.removeChild(ta);
    }

    async downloadBackup() { 
        const date = new Date(); 
        const fileName = `Komunalka_Backup_${date.toISOString().slice(0,10)}.txt`; 
        const str = JSON.stringify(this.state); 
        const file = new File([str], fileName, { type: "text/plain" });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({ files: [file], title: '–ó–±–µ—Ä–µ–≥—Ç–∏ –±–µ–∫–∞–ø', text: '–§–∞–π–ª –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å' });
                return;
            } catch (e) { console.log("Share skipped"); }
        }
        
        const a = document.createElement('a'); 
        a.href = "data:text/plain;charset=utf-8," + encodeURIComponent(str); 
        a.download = fileName; 
        document.body.appendChild(a); a.click(); a.remove(); 
        alert("–ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —è–∫ —Ç–µ–∫—Å—Ç–æ–≤–∏–π —Ñ–∞–π–ª.");
    }

    loadBackup(inpt) { 
        const f = inpt.files[0]; if(!f) return; 
        if (!confirm("–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∑ —Ñ–∞–π–ª—É? –ü–æ—Ç–æ—á–Ω—ñ –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –¥–∞–Ω—ñ –±—É–¥–µ –≤—Ç—Ä–∞—á–µ–Ω–æ.")) { inpt.value=''; return; }
        const r = new FileReader(); 
        r.onload = e => { try { this.state = JSON.parse(e.target.result); this.save(); alert("–£—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!"); location.reload(); } catch(x) { alert("–ü–æ–º–∏–ª–∫–∞ —Ñ–∞–π–ª—É"); } }; 
        r.readAsText(f); 
    }

    async sharePDF(i) {
        if (typeof html2pdf === 'undefined') { alert('–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ PDF –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç.'); return; }
        window.scrollTo(0, 0);

        const a = this.currentData.apartments[i]; const d = this.currentData; const dStr = new Date().toLocaleDateString('uk-UA');
        const c = { ed: Math.max(0,(a.curr.ed||0)-(a.prev.ed||0)), en: Math.max(0,(a.curr.en||0)-(a.prev.en||0)), w: Math.max(0,(a.curr.w||0)-(a.prev.w||0)), g: Math.max(0,(a.curr.g||0)-(a.prev.g||0)) };
        const cost = { ed: (c.ed*d.tariffs.el_d) + (c.en*d.tariffs.el_n), w: c.w*d.tariffs.w, g: c.g*d.tariffs.g };
        const mzkVal = parseFloat((this.checks[i].match(/–ú–ó–ö: (\d+\.\d+)/) || [0,0])[1]);
        let sRows = a.services.map(s => `<tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:5px;">${s.name}</td><td style="padding:5px;text-align:right;">${s.val.toFixed(2)}</td></tr>`).join('');
        let tot = cost.ed + cost.w + cost.g + a.services.reduce((s,x)=>s+x.val,0) + mzkVal + (a.debt||0);

        const logoHTML = `<div style="font-family: sans-serif; font-weight: 900; font-size: 20px; color: #1e293b; display: flex; align-items: center; justify-content:center;"><span style="color:#1e293b">–ö–æ–º—É–Ω–∞–ª–∫</span><div style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #0099ff; border-radius: 50%; margin: 0 2px;"><div style="width: 6px; height: 6px; background: white; border-radius: 50%;"></div></div><span style="color:#0099ff">–±–ª—ñ–∫</span></div>`;

        const template = `
        <div style="font-family: 'Inter', sans-serif; color:#1e293b; background:#fff; padding:30px; box-sizing: border-box; width: 100%; text-align: center;">
            <div style="margin-bottom:20px;">${logoHTML}<div style="font-size:12px; margin-top:5px; color:#64748b;">${d.name}</div></div>
            <div style="display:flex; justify-content:space-between; border-bottom:2px solid #0099ff; padding-bottom:10px; margin-bottom:15px; max-width: 100%;">
                <div style="font-weight:bold; font-size:14px;">–†–ê–•–£–ù–û–ö</div><div style="font-size:12px;">${dStr}</div>
            </div>
            <div style="background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:15px; font-size:14px; text-align: left;">–ü–ª–∞—Ç–Ω–∏–∫: <strong>${a.name}</strong></div>
            <table style="width:100%; border-collapse:collapse; font-size:11px; margin: 0 auto;">
                <tr style="background:#f8fafc; color:#64748b;"><th style="padding:5px; text-align:left;">–ü–æ—Å–ª—É–≥–∞</th><th style="padding:5px; text-align:right;">–°—É–º–∞</th></tr>
                <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:5px; text-align:left;">‚ö° –ï–ª–µ–∫—Ç—Ä–∏–∫–∞</td><td style="padding:5px; text-align:right;">${cost.ed.toFixed(2)}</td></tr>
                <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:5px; text-align:left;">üíß –í–æ–¥–∞</td><td style="padding:5px; text-align:right;">${cost.w.toFixed(2)}</td></tr>
                <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:5px; text-align:left;">üî• –ì–∞–∑</td><td style="padding:5px; text-align:right;">${cost.g.toFixed(2)}</td></tr>
                <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:5px; text-align:left;">üè¢ –ú–ó–ö</td><td style="padding:5px; text-align:right;">${mzkVal.toFixed(2)}</td></tr>
                ${sRows}
            </table>
            <div style="text-align:right; margin-top:20px;">
                <div style="font-size:10px; color:#64748b;">–†–∞–∑–æ–º –¥–æ —Å–ø–ª–∞—Ç–∏:</div>
                <div style="font-size:22px; font-weight:bold; color:#0099ff;">${tot.toFixed(2)} –≥—Ä–Ω</div>
                ${a.debt > 0 ? `<div style="font-size:10px; color:#ef4444;">(–í–∫–ª. –±–æ—Ä–≥ ${a.debt})</div>` : ''}
            </div>
            <div style="margin-top:30px; border-top:1px dashed #cbd5e1; padding-top:10px; text-align: left;">
                <div style="font-size:10px; font-weight:bold; color:#64748b; margin-bottom:3px;">–†–ï–ö–í–Ü–ó–ò–¢–ò:</div>
                ${d.requisites.map(r=>`<div style="font-size:10px; margin-bottom:2px;">üè¶ ${r.name}: <strong>${r.val}</strong></div>`).join('')}
            </div>
        </div>`;

        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #555; z-index: 99999; display: flex; justify-content: center; overflow: auto; padding: 20px;';
        const container = document.createElement('div');
        container.style.cssText = 'width: 148mm; background: white; margin: 0 auto; box-shadow: 0 0 20px rgba(0,0,0,0.5);'; 
        container.innerHTML = template;
        overlay.appendChild(container);
        document.body.appendChild(overlay);

        await new Promise(r => setTimeout(r, 800)); 

        const fileName = `Rahunok_${a.name.replace(/\s/g,'_')}.pdf`;
        const opt = { margin: 0, filename: fileName, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, logging: false }, jsPDF: { unit: 'mm', format: 'a5', orientation: 'portrait' } };
        
        try { 
            const pdfWorker = html2pdf().set(opt).from(container);
            try {
                const pdfBlob = await pdfWorker.output('blob');
                const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: '–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è', text: `–†–∞—Ö—É–Ω–æ–∫ –¥–ª—è ${a.name}` });
                } else { throw new Error("No share"); }
            } catch (e) { await pdfWorker.save(); }
        } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞ PDF: " + e.message); } 
        finally { document.body.removeChild(overlay); }
    }

    startNewMonth() { 
        if (!confirm("–ó–∞–∫—Ä–∏—Ç–∏ –º—ñ—Å—è—Ü—å? (–ü–æ—Ç–æ—á–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ -> –ú–∏–Ω—É–ª—ñ, —Å–∫–∏–Ω—É—Ç–∏ —Å–ø–ª–∞—Ç—É)")) return; 
        this.currentData.apartments.forEach(a => { 
            ['ed','en','w','g'].forEach(k=>{if(a.curr[k]){a.prev[k]=a.curr[k];a.curr[k]=0}}); 
            a.paid=0; 
        }); 
        this.currentData.groups.forEach(g => { 
            ['ed','en','w','g'].forEach(k=>{if(g.curr[k]){g.prev[k]=g.curr[k];g.curr[k]=0}}); 
        }); 
        this.save(); location.reload(); 
    }
}
const app = new App();
</script>
</body>
</html>
